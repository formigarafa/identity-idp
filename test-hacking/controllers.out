
Randomized with seed 33911

Idv::StepIndicatorConcern
  #step_indicator_steps
    returns doc auth steps
    with pending profile
      returns doc auth gpo steps
    with gpo address verification method
      returns doc auth gpo steps
    with in person proofing component
      with proofing component via current idv session
        returns in person steps
        with gpo address verification method
          returns in person gpo steps
      with proofing component via pending profile
        returns in person gpo steps

Idv::PersonalKeyController
  before_actions
    includes before_actions from AccountStateChecker
    includes before_actions from IdvSession
    #confirm_profile_has_been_created
      profile has been created
        does not redirect
      profile has not been created
        redirects to the account path
  #show
    sets code instance variable
    sets flash.now[:success]
    sets flash[:allow_confirmations_continue] to true
    can decrypt the profile with the code
    logs when user generates personal key
  #update
    with device profiling decisioning enabled
      redirects to account path when threatmetrix review status is nil
      redirects to come back later path when device profiling fails
      redirects to account path when device profiling passes
    user selected gpo verification
      redirects to come back later path
      with in person profile
        creates a profile and returns completion url
    with in person profile
      creates a profile and returns completion url
    user selected phone verification
      clears need_personal_key_confirmation session state
      redirects to sign up completed for an sp
      redirects to the account path when no sp present

Idv::SessionsController
  #destroy
    redirect occurs to the start of identity verification
    tracks the event in analytics
    pending profile
      cancels verification attempt
    when destroying the session
      clears the idv/in_person session
      clears the idv/inherited_proofing session
      clears the idv/doc_auth session
      clears the decrypted_pii session
    with in person enrollment
      cancels pending in person enrollment
      cancels establishing in person enrollment

Redirect::ContactController
  #show
    redirects to contact page

SignUp::CompletionsController
  #show
    requires service provider issuer in session
    requires service provider or identity info in session
    requires user with session to be logged in
    requires user with no session to be logged in
    renders partials
      renders show if the user has identities and no active session
    user signed in, sp info present
      redirects to account page when SP request URL is not present
      IAL2
        tracks page visit
      IAL1
        tracks page visit
  #update
    IAL2
      updates verified attributes
      tracks analytics
      sends the in-person proofing completion survey
    IAL1
      updates verified attributes
      tracks analytics
      redirects to account page if the session request_url is removed

EventDisavowalController
  #new
    with a valid disavowal_token
      tracks an analytics event
      assigns forbidden passwords
    with an invalid disavowal_token
      tracks an analytics event
      does not assign forbidden passwords
  #create
    with an event whose user has been deleted
      errors
    with an invalid password
      tracks an analytics event
      assigns forbidden passwords
    with a valid password
      tracks an analytics event
    with an invalid disavowal_token
      tracks an analytics event

SignUp::PasswordsController
  #create
    rejects when confirmation_token is invalid
    tracks an invalid password event
    tracks a valid password event
  #new
    rejects when confirmation_token is invalid
    instructs crawlers to not index this page

Users::PhoneSetupController
  GET index
    when signed in
      renders the index view
    when signed out
      redirects to sign in page
  PATCH create
    tracks an event when the number is invalid
    with SMS
      prompts to confirm the number
    without selection
      prompts to confirm via SMS by default
    with voice
      prompts to confirm the number
  before_actions
    includes the appropriate before_actions

Api::Verify::BaseController
  #create
    renders as unauthorized (401)
    with authenticated user
      renders as ok (200)
      with request forgery protection enabled
        renders as ok (200)

TwoFactorAuthentication::PivCacVerificationController
  #show
    when the user presents an invalid piv/cac
      displays flash error message
      redirects to the piv/cac entry screen
      increments second_factor_attempts_count
      resets the piv/cac session information
    when the user lockout period expires
      when user submits a valid piv/cac
        resets attempts count
        resets second_factor_locked_at
      when user submits an incorrect piv/cac
        resets the x509 session information
        resets second_factor_locked_at
        resets attempts count
    before the user presents a valid PIV/CAC
      renders a page with a submit button to capture the cert
    when the user has reached the max number of piv/cac attempts
      tracks the event
    when the user presents a valid PIV/CAC
      resets the second_factor_attempts_count
      tracks the valid authentication event
      redirects to the profile
    when the user presents a different piv/cac
      displays flash error message
      redirects to the piv/cac entry screen
      resets the piv/cac session information
      increments second_factor_attempts_count
    when the user does not have a piv/cac associated
      and no token is provided
        redirects to user_two_factor_authentication_path
      and a token is provided
        redirects to user_two_factor_authentication_path

ReactivateAccountController
  #index
    with a password reset profile
      renders the index template
    wthout a password reset profile
      redirects to the root url
  #update
    redirects user to idv_url
  before_actions
    requires the user to be logged in

AccountReset::ConfirmRequestController
  #show
    no email in flash
      redirects to the new user registration path
    email is present in flash
      renders the show template

Idv::ImageUploadsController
  #create
    when required pii field is missing from doc response
      returns error
    throttling
      returns an error when throttled
      tracks events
      returns remaining_attempts with error
    when fields are missing
      tracks events
      returns error status when not provided image fields
    when image upload fails
      returns an error response
      tracks events
    when image upload succeeds
      tracks events
      returns a successful response and modifies the session
      but doc_pii validation fails
        due to invalid Name
          tracks name validation errors in analytics
        but doc_pii validation fails due to invalid DOB
          tracks dob validation errors in analytics
        due to invalid State
          tracks state validation errors in analytics
    when a value is an error-formatted yaml file
      tracks events
      returns error from yaml file
    when a value is not a file
      tracks events
      returns an error
      with a locale param
        translates errors using the locale param
    when document capture session is invalid
      returns error status when document_capture_session is invalid
      returns error status when document_capture_session is not provided

Risc::SecurityEventsController
  #create
    creates a security event record
    tracks an successful in analytics
    with a bad request
      renders an error response and does not create a security event record
      tracks an error event in analytics

Idv::CaptureDocStatusController
  #show
    when capture succeeded with barcode attention
      when loaded result expires but session was already marked with attention result
        when barcode attention result is pending confirmation
          assigns flow session values as having received attention result
          returns pending result
        when result is confirmed
          returns success
          assigns flow session values as having received attention result
      when result is confirmed
        returns success
        assigns flow session values as having received attention result
      when user receives a second result that is not the attention result
        assigns flow session values as not having received attention result
      when barcode attention result is pending confirmation
        assigns flow session values as having received attention result
        returns pending result
    when flow session expires
      returns unauthorized
    when the user is throttled
      returns throttled with redirect
    when capture failed
      returns unauthorized
    when user opted for in-person proofing
      returns success with redirect
    when session does not exist
      returns unauthorized
    when capture succeeded
      returns success
    when unauthenticated
      redirects to the root url
    when the user cancelled document capture on their phone
      returns cancelled
    when result is pending
      returns pending result

Accounts::PersonalKeysController
  #new
    tracks an event for viewing profile personal key
  #create
    tracks CSRF errors
    generates a new personal key, tracks an analytics event, and redirects
    prompts for password if PII is not present
  before_actions
    require recent reauthn

Idv::SetupErrorsController
  renders the show template

Users::BackupCodeSetupController
  deletes backup codes
  does not deletes backup codes if they are the only mfa
  creates backup codes and logs expected events
  with multiple MFA selection turned off
    redirects to account page
  #refreshed
    does not 500 when codes have not been generated
  with multiple MFA selection on
    when user only selects backup code on account creation
      redirects to Suggest 2nd MFA page
    when user selects multiple mfas on account creation
      redirects to Phone Url Page after page

SamlIdpController
  GET /api/saml/auth
    SP's can have signed_response_message_requested set
      with signed_response_message_requested true
        finds a Signature referencing the Response
        finds Signatures in the message and assertion
      with signed_response_message_requested false
        only finds one Signature
        only finds a Signature referencing the Assertion

Idv::ForgotPasswordController
  #update
    tracks appropriate events
  #new
    tracks the event in analytics when referer is nil
  before_actions
    includes before_actions from IdvSession

Idv::ReviewController
  #confirm_idv_phone_confirmed
    user phone is not confirmed
      redirects to phone confirmation
    user phone is confirmed
      does not redirect
    user is verifying by mail
      does not redirect
  before_actions
    includes before_actions from IdvSession
    includes before_actions from AccountStateChecker
  #confirm_current_password
    user provides correct password
      allows request to proceed
    user provides wrong password
      tracks irs password entered event (idv_password_entered)
      redirects to new
    user does not provide password
      redirects to new
  #new
    user has not requested too much mail
      displays a success message
    user has requested too much mail
      displays a helpful error message
    user has completed all steps
      shows completed session
      displays a helpful flash message to the user
  #confirm_idv_steps_complete
    user has missed address step
      redirects to address step
  #create
    user has completed all steps
      creates Profile with applicant attributes
      tracks irs password entered event (idv_password_entered)
      redirects to confirmation path after user presses the back button
      redirects to personal key path
      user picked GPO confirmation
        leaves profile deactivated
      user picked phone confirmation
        activates profile
        creates an `account_verified` event once per confirmation
        dispatches account verified alert
        with in person profile
          redirects to personal key path
          creates a USPS enrollment
          sends ready to verify email
          creates an in-person enrollment record
          does not dispatch account verified alert
          when the USPS response is missing an enrollment code
            logs an error message
            leaves the enrollment in establishing
          when user enters an address2 value
            provides address2 if the user entered it
          when there is a 4xx error
            leaves the enrollment in establishing
            logs the response message
          when there is 5xx error
            leaves the enrollment in establishing
            allows the user to retry the request
            logs the error message
        with threatmetrix required but review status did not pass
          creates a disabled profile
        when the user goes through reproofing
          does not log a reproofing event during initial proofing
          logs a reproofing event upon reproofing
    user fails to supply correct password
      redirects to original path

FrontendLogController
  #create
    anonymous user with session-associated user id
      succeeds
    user is signed in
      succeeds
      invalid param
        rejects a non-hash payload
        rejects a non-string event
      empty payload
        succeeds
      missing a parameter
        rejects a request without specifying event
        rejects a request without specifying payload
      for a named analytics method
        logs the analytics event without the prefix
      allowlisted analytics event
        succeeds
        with payload
          succeeds
          with missing keyword arguments
            gracefully sets the missing values to nil

Users::EmailsController
  #resend
    valid email exists in session
      sends email
    no valid email exists in session
      shows an error and redirects to add email page
  #limit
    user exceeds email limit
      displays error if email exceeds limit
  #verify
    with malformed payload
      does not blow up

Idv::SessionErrorsController
  before_actions
    includes before_actions from IdvSession
  #exception
    behaves like an idv session errors controller action
      the user is not authenticated and not recovering their account
        redirects to sign in
      the user is authenticated and has not confirmed their profile
        renders the error
      the user is not authenticated and in doc capture flow
        renders the error
      the user is authenticated and has confirmed their profile
        redirects to the phone url
  #warning
    behaves like an idv session errors controller action
      the user is not authenticated and not recovering their account
        redirects to sign in
      the user is not authenticated and in doc capture flow
        renders the error
      the user is authenticated and has not confirmed their profile
        renders the error
      the user is authenticated and has confirmed their profile
        redirects to the phone url
    with throttle attempts
      assigns remaining count
      assigns URL to try again
      in in-person proofing flow
        assigns URL to try again
  #throttled
    while throttled
      assigns expiration time
    behaves like an idv session errors controller action
      the user is not authenticated and in doc capture flow
        renders the error
      the user is not authenticated and not recovering their account
        redirects to sign in
      the user is authenticated and has confirmed their profile
        redirects to the phone url
      the user is authenticated and has not confirmed their profile
        renders the error
  #failure
    while throttled
      assigns expiration time
    behaves like an idv session errors controller action
      the user is not authenticated and not recovering their account
        redirects to sign in
      the user is authenticated and has confirmed their profile
        redirects to the phone url
      the user is authenticated and has not confirmed their profile
        renders the error
      the user is not authenticated and in doc capture flow
        renders the error
  #ssn_failure
    behaves like an idv session errors controller action
      the user is authenticated and has confirmed their profile
        redirects to the phone url
      the user is not authenticated and in doc capture flow
        renders the error
      the user is not authenticated and not recovering their account
        redirects to sign in
      the user is authenticated and has not confirmed their profile
        renders the error
    while throttled
      assigns expiration time

Api::Verify::DocumentCaptureErrorsController
  extends behavior of base api class
  #delete
    renders as unauthorized (401)
    with hybrid effective user
      behaves like deleting document capture errors
        renders errors for missing fields
        with valid document capture session
          deletes errors and renders successful response
        with invalid document capture session
          renders errors for invalid document capture session
    with signed in user
      behaves like deleting document capture errors
        renders errors for missing fields
        with valid document capture session
          deletes errors and renders successful response
        with invalid document capture session
          renders errors for invalid document capture session

SamlIdpController
  /api/saml/logout
    tracks the event when the saml request is invalid
    tracks the event when idp initiated
    rejects requests from a wrong cert
    accepts requests from a correct cert
    tracks the event when sp initiated
  /api/saml/remotelogout
    rejects requests from a correct cert but a non-associated user
    tracks the event when the saml request is invalid
    rejects requests from a correct cert but no session index
    rejects requests from a wrong cert
    rejects requests from a correct cert but bad session index
    accepts requests with correct cert and correct session index and renders logout response
  #external_saml_request
    returns false for empty referer
    returns false for malformed referer
  /api/saml/metadata
    contains the organization display name
    contains a signature nodeset
    contains the correct NameID formats
    contains a digest method nodeset with SHA256 algorithm
    contains an EntityDescriptor nodeset
    contains the organization name
    renders XML inline
    contains the organization name under AttributeAuthorityDescriptor
    contains a signature method nodeset with SHA256 algorithm
    contains the org display name under AttributeAuthorityDescriptor
    disables caching
  before_actions
    includes the appropriate before_actions
  GET /api/saml/auth
    both service provider and authn_context are invalid
      responds with an error page
    service provider uses email NameID format and is allowed to use email
      Subject
        has a saml:Subject element
        NameID
          has a saml:NameID element
          has NameID value of the email address of the user making the AuthN Request
          has a format attribute defining the NameID to be email
    authn_context scenarios
      authn_context is missing
        returns saml response with default AAL in authn context
      authn_context is defined by sp
        returns default AAL authn_context when IAL1 is requested
        returns AAL2 authn_context when AAL2 is requested
        returns AAL2-phishing-resistant authn_context when AAL2-phishing-resistant requested
        returns default AAL authn_context when default AAL and IAL1 is requested
        returns AAL3-HSPD12 authn_context when AAL3-HSPD12 is requested
        returns AAL2-HSPD12 authn_context when AAL2-HSPD12 is requested
        returns AAL3 authn_context when AAL3 is requested
    POST to auth correctly stores SP in session
      correctly sets the request URL
      stores SP metadata in session
    user is not redirected to IdV
      tracks the authentication without IdV redirection event
    authn_context is invalid
      renders an error page
    user has not finished verifying profile
      tracks the authentication with finish_profile==true
    HEAD /api/saml/auth
      responds with "403 Forbidden"
    service provider uses email NameID format but is not allowed to use email
      returns an error
    after signing in
      does not call IdentityLinker
    service provider has the wrong certs
      deoes not blow up
    nameid_format is missing
      defaults to email when added to issuers_with_email_nameid_format
      defaults to persistent
    service provider is inactive
      responds with an error page
    no IAL explicitly requested
      notes that in the analytics event
    service provider sends unsupported NameID format
      sends the appropriate identifier for non-email NameID SPs
      sends the old user ID for legacy SPS
      sends the appropriate identifier for email NameID SPs
    user requires ID verification
      tracks the authentication and IdV redirection event
    no matching cert from the SAML request
      notes that in the analytics event
    SAML Response
      includes an Issuer element inherited from the base URL
      returns a valid xml document
      includes the required StatusCode
      returns a Success status code
      includes a Status element with a StatusCode child element
      sets correct CSP config that includes any custom app scheme uri from SP redirect_uris
      AuthnContext
        has a saml:AuthnContext element
        AuthnContextClassRef
          has contents set to AAL2
          has a saml:AuthnContextClassRef element
      saml:AttributeStatement
        includes the uuid Attribute element
        includes the email Attribute element
        includes the saml:AttributeStatement element
        does not include the phone Attribute element when authn_context is IAL1
      Assertion
        includes the xmlns:saml attribute in the element
        includes an Version attribute set to v2.0
        includes an IssueInstant attribute with a timestamp
        includes an ID attribute with a valid UUID
      Transforms
        includes a Transform specifying the Schema for XML Signatures
        includes a Transforms element specifying multiple transformation algorithms
        includes a Transform specifying the Canonical XML serialization
      ds:Signature
        includes the saml cert from the certs folder
        includes a X509Certificate element
        includes a KeyInfo element
        includes the ds:Signature element with the signature namespace
        includes a X509Data element
        includes a SignatureValue element
      AuthnStatement
        has an AuthnInstant attribute
        has a SessionIndex attribute
        has a saml:AuthnStatement element
      Conditions
        has a saml:Conditions element
        has a NotOnOrAfter attribute
        has a NotBefore attribute
      SignedInfo
        includes a CanonicalizationMethod element
        includes a SignedInfo element
        includes a SignatureMethod element specifying rsa-sha256
        includes a DigestMethod element
        has valid signature
        Reference
          includes a Reference element
          includes a URI attribute
      Subject
        has a saml:Subject element
        NameID
          has a format attribute specifying the email format
          has the UUID of the user making the AuthN Request
          has a saml:NameID element
        SubjectConfirmation
          has a method attribute specifying the bearer method
          has a SubjectConfirmation element
          SubjectConfirmationData
            has a Recipient attribute
            has a NotOnOrAfter attribute
            has an InResponseTo attribute
            has a SubjectConfirmationData element
    with IAL1
      does not redirect the user to the IdV URL
    with invalid SAMLRequest param
      responds with "403 Forbidden"
    with IAL2 and the profile is reset
      redirects to IdV URL for IAL2 proofer
    with IAL2 and the identity is already verified
      behaves like a verified identity
        calls AttributeAsserter#build
        does not redirect the user to the IdV URL
        tracks IAL2 authentication events
        contains verified attributes
        sets identity ial
        profile is not in session
          redirects to password capture if profile is verified but not in session
    ForceAuthn set to true
      signs the user out if a session is active
    when user is not logged in
      logs SAML Auth Request but does not log SAML Auth
      redirects the user to the SP landing page with the request_id in the params
    service provider is valid
      stores SP metadata in session
      after successful assertion of ial1
        does not create an identity record until the user confirms attributes
        redirects to verify attributes
        redirects if verified attributes dont match requested attributes
        does not delete SP metadata from session
        does not redirect after verifying attributes
    with missing SAMLRequest params
      responds with "403 Forbidden"
    service provider has multiple certs
      encrypts the response to the right key
    with IALMAX and the identity is already verified
      tracks IAL2 authentication events
      sets identity ial to 0
      calls AttributeAsserter#build
      does not redirect the user to the IdV URL
      contains verified attributes
      profile is not in session
        redirects to password capture if profile is verified but not in session
    service provider is invalid
      responds with an error page

EffectiveUser
  #effective_user
    logged in
      returns session user id
    non-existent user
      returns session user id
    logged out
      returns nil
    logged out with doc capture session user id
      returns session user id

OpenidConnect::TokenController
  #create
    with invalid form
      is a 400 and has an error response and no id_token
    with valid params
      tracks a successful event in analytics
      is successful and has a response with the id_token
    with invalid params
      is a 400 and has an error response and no id_token
      tracks an unsuccessful event in analytics

Idv::GpoVerifyController
  #index
    user does not have pending profile
      redirects to account page
    with throttle reached
      renders throttled page
    user has pending profile
      renders page
      shows throttled page is user is throttled
  #create
    with throttle reached
      renders the index page to show errors
    with a valid form
      dispatches account verified alert
      redirects to the sign_up/completions page
      with establishing in person enrollment
        redirects to ready to verify screen
        does not dispatch account verified alert
    with an invalid form
      does not 500 with missing form keys
      redirects to the index page to show errors

Idv::InheritedProofingCancellationsController
  before_actions
    includes before_actions from IdvSession
    includes before_actions from AllowlistedFlowStepConcern
    includes before_actions from InheritedProofing404Concern
  #destroy
    when there is a session
      destroys session
      tracks the event in analytics
      renders a json response with the redirect path set to account_path
    when there is no session
      redirects to root
  #update
    tracks the event in analytics
    redirects to idv_inherited_proofing_path
    when a go back path is stored in session
      redirects to go back path
  #new
    when there is a session
      stores go back path
      tracks the event in analytics
      renders template
    when the inherited proofing feature flipper is turned off
      #new
        behaves like an HTML 404 not found
          returns a 404 not found
      #destroy
        behaves like an HTML 404 not found
          returns a 404 not found
      #update
        behaves like an HTML 404 not found
          returns a 404 not found
    when there is no session
      redirects to root
    when the flow step is not in the allowed list
      #destroy
        behaves like an HTML 404 not found
          returns a 404 not found
      #update
        behaves like an HTML 404 not found
          returns a 404 not found
      #new
        behaves like an HTML 404 not found
          returns a 404 not found

Users::ForgetAllBrowsersController
  #show
    logs an analytics event for visiting
    renders
    does not change remember_device_revoked_at
  before_actions
    includes appropriate before_actions
  #destroy
    redirects to the account page
    updates the remember_device_revoked_at attribute for the user
    logs an analytics event for forgetting

Users::AuthorizationConfirmationController
  #create
    redirects to the sp request url
  #destroy
    signs out the user and redircts to sign in with the request id
  #new
    renders for a signed in user
    redirects for a user without an SP

Idv::DocAuthController
  #index
    redirects to the first step
    with pending in person enrollment
      redirects to in person ready to verify page
  async document verify status
    returns status of hard fail
    returns status of fail with incomplete PII from doc auth
    returns status of fail
    returns status of in progress
    returns status of success
  #show
    increments the analytics step counts on subsequent submissions
    redirects to the right step
    renders a 404 with a non existent step
    renders the correct template
    tracks analytics
    tracks analytics for the optional step
    with an existing applicant
      finishes the flow
  #update
    tracks analytics
    redirects from welcome to no camera error
    increments the analytics step counts on subsequent submissions
    with an existing applicant
      finishes the flow
  before_actions
    includes corrects before_actions
    includes before_actions from IdvSession
  unauthenticated
    redirects to the root url

Test::PivCacAuthenticationTestSubjectController
  when in development
    POST create
      returns a redirect
    FeatureManagement#development_and_identity_pki_disabled?
      is enabled
    GET new
      renders a page
  when not in development
    routes
      has a route to GET new
    FeatureManagement#development_and_identity_pki_disabled?
      is disabled
    POST create
      redirects to root_url
    GET new
      redirects to root_url

ForgotPasswordController
  #show
    no email in session
      redirects to the new user password path
    email in session
      renders the page

Idv::InPersonController
  #index
    renders 404 not found
    with in person proofing enabled
      redirects to the root url
      signed in
        redirects to idv
        with establishing in-person enrollment
          redirects to the first step
          with associated service provider
            renders 404 not found
            with in person proofing enabled for service provider
              redirects to the first step
          with an existing applicant
            finishes the flow
  before_actions
    includes corrects before_actions

Users::PasswordsController
  #update
    form returns success
      sends a security event
      sends the user an email
      creates a user Event for the password change
      calls UpdateUserPassword
      redirects to profile and sends a password change email
    form returns failure
      renders edit
      does not create a password_changed user Event
  #edit
    user has a profile with PII
      redirects to capture password if PII is not decrypted
      renders form if PII is decrypted

Idv::CancellationsController
  #new
    tracks the event in analytics when referer is nil
    tracks the event in analytics when step param is present
    tracks the event in analytics when referer is present
    when hybrid session
      renders template
      stores go back path
    when no session
      redirects to root
    when regular session
      renders template
      stores go back path
  #destroy
    tracks an analytics event
    when hybrid session
      renders template
      cancels document capture
    when regular session
      destroys session
      renders template
      with in person enrollment
        cancels pending in person enrollment
        deletes in person flow data
        cancels establishing in person enrollment
    when no session
      redirects to root
  #update
    redirects to idv_path
    logs cancellation go back
    with go back path stored in session
      redirects to go back path
  before_actions
    includes before_actions from IdvSession

Api::Verify::DocumentCaptureController
  extends behavior of base api class
  #create
    renders as bad request (400)
    When user document is submitted to be verified
      returns inprogress status when create is called
      When the request does not have all the parameters
        returns 400 and gives error message
    signed out
      renders as unauthorized (401)
      with hybrid effective user
        renders as bad request (400)

RenderConditionConcern
  #index
    renders 404
    all feature enabled
      renders page
      show feature enabled
        renders page
  #show
    renders 404
    all feature enabled
      renders 404
      show feature enabled
        renders page
  with json response handling
    renders 404 api response

Health::OutboundController
  #index
    when the outbound connections are uhealthy
      is a 500
      renders the error
    when the outbound connections are healthy
      is a 200
      renders the result

ApplicationController
  #sp_session_request_url_with_updated_params
    leaves a nil url alone
    with a url that has prompt=login
      changes it to prompt=select_account
    with saml_internal_post feature flag set to false
      with an OIDC request
        returns the original request
      when the locale has been changed
        adds the locale to the url
      with a url that has prompt=login
        changes it to prompt=select_account
      with a SAML request
        returns the original request url
    with an OIDC request
      returns the original request
    with a SAML request
      returns the saml completion url
    when the locale has been changed
      adds the locale to the url
  #analytics
    when a current_user is present
      calls the Analytics class by default with current_user, request, and issuer
    when a current_sp is not present
      does not perform a DB lookup
    when a current_user is not present
      calls the Analytics class with AnonymousUser.new and request parameters
  #cache_issuer_in_cookie
    with a current_sp
      sets sets the cookie sp_issuer (FAILED - 1)
    without a current_sp
      clears the cookie sp_issuer
  handling InvalidAuthenticityToken exceptions
    redirects back to home page if present and referer is invalid
    tracks the InvalidAuthenticityToken event and does not sign the user out
    redirects back to home page if present and referer is external
    redirects back to referer if present and is not external
  #append_info_to_payload
    adds user_uuid and git metadata to the lograge output
  #sign_out
    deletes the ahoy_visit cookie when signing out
  #confirm_two_factor_authenticated
    not signed in
      redirects to sign in page
    is 2FA-enabled
      prompts user to enter their OTP
    is not 2FA-enabled
      redirects to phone_setup_url with a flash message
  #disable_caching
    sets headers to disable cache
  handling UnsafeRedirectError exceptions
    redirects back to home page
    tracks the Unsafe Redirect event and does not sign the user out
  handling RequestTimeoutException exceptions
    returns an html page
    returns a proper status
  #create_user_event
    when the user is not specified
      creates an Event object for the current_user
    when the user is specified
      creates an Event object for the specified user
  #redirect_on_timeout
    returns a 400 bad request when a url generation error is raised on the redirect
    when the current user is present
      does not display flash message
    when there is no current user
      displays a flash message
  #session_expires_at
    when URL contains the host parameter
      does not redirect to the host
    when URL contains the request_id parameter
      preserves the request_id parameter
    when URL does not contain the timeout parameter
      does not redirect anywhere
  #set_x_request_url
    sets the X-Request-URL header

Users::ServiceProviderRevokeController
  #show
    renders
    logs an analytics event for visiting
    when the sp_id links to a valid SP but it has not been linked
      does not error, just redirects to the account page
    when the sp_id is not valid
      does not error, just redirects to the account page
  before_actions
    includes appropriate before_actions
  #destroy
    logs an analytics event for revoking
    marks the identity as deleted and redirects
    when the sp_id is not valid
      does not error, just redirects to the account page
    when the sp_id links to a valid SP but it has not been linked
      does not error, just redirects to the account page

TwoFactorAuthentication::WebauthnVerificationController
  when signed in before 2fa
    patch confirm
      tracks an invalid submission
      tracks a valid non-platform authenticator submission
      tracks a valid platform authenticator submission
      webauthn_platform returns an error from frontend API
        User has multiple MFA options
          displays flash error message
          redirects to webauthn show page
        User only has webauthn as an MFA method
          redirects to webauthn error page
    GET show
      redirects if no webauthn configured
      with webauthn configured
        tracks an analytics event
  when not signed in
    patch confirm
      redirects to root url
    GET show
      redirects to root url

Users::SessionsController
  GET /logout
    tracks a logout event
  POST /
    tracks unsuccessful authentication for locked out user
    returns to sign in page if email is a Hash
    tracks unsuccessful authentication for too many auth failures
    redirects back to home page if CSRF error and referer is invalid
    tracks the authentication attempt for nonexistent user
    redirects to the reset pending page if there are pending account reset requests
    tracks the presence of SP request_url in session
    redirects to 2FA if there are no pending account reset requests
    tracks the successful authentication for existing user
    tracks the unsuccessful authentication for existing user
    tracks CSRF errors
    IAL1 user
      computes one SCrypt hash for the user password
    with a user that accepted the rules of use more than 6 years ago
      redirects to the rules of user url
    with user that is up to date with rules of use
      redirects to 2fa since there is no pending account reset rewquests
    with remember_device cookie present but expired
      only tracks the cookie presence in analytics
    with remember_device cookie present and valid
      tracks the cookie validity in analytics
    IAL2 user
      caches unverified PII pending confirmation
      deactivates profile if not de-cryptable
      computes one SCrypt hash for the user password and one for the PII
      caches PII in the user session
    with user that is not up to date with rules of use
      redirects to rules of use url
  GET /users/sign_in
    clears the session when user is not yet 2fa-ed
  GET /active
    does not track analytics event
    when user is not present
      updates the pinged_at session key
      includes the remaining time
      sets live key to false
      includes session_expires_at
    when user is present
      renders json
      includes the remaining key
      clears the Etag header
      sets live key to true
      includes the timeout key
      returns a 200 status code
  GET /timeout
    tracks the timeout
    signs the user out
    redirects to the homepage
  POST /sessions/keepalive
    does not track analytics event
    when user is not present
      includes the remaining time
      includes session_expires_at
      sets live key to false
    when user is present
      clears the Etag header
      resets the remaining key
      returns a 200 status code
      resets the timeout key
      tracks session refresh visit
      renders json
  #new
    with fully authenticated user who has a pending profile
      redirects to the verify profile page
    with a garbage request_id
      does not blow up with a hash
      does not reflect request_id values that do not look like UUIDs
    with fully authenticated user
      redirects to the profile page
    with current user
      logs the user out
    with a new user
      tracks page visit, any alert flashes, and the Devise stored location
      renders the new template
      renders partials
        renders the return to service provider template when arriving from an SP
  DELETE /logout
    tracks a logout event

Users::MfaSelectionController
  #index
    when the user is using one authenticator option
      shows the mfa setup screen
  #update
    submits the TwoFactorOptionsForm
    when the selection is only phone and multi mfa is enabled
      the redirect to the form page with an anchor
      contains a flash message
    when the selection is webauthn platform authenticator
      redirects to webauthn setup page with the platform param
    when the selection is phone
      redirects to phone setup page
    when the form is empty
      with no active MFA
        redirects to the index page with a flash error
      with an active MFA
        redirects to after_mfa_setup_path
    when the selection is not valid
      renders the index page
    when the selection is piv_cac
      redirects to piv/cac setup page
    when multi selection with phone first
      redirects properly
    when the selection is auth_app
      redirects to authentication app setup page
    when the selection is webauthn
      redirects to webauthn setup page
    when multi selection with auth app first
      redirects properly

Users::ResetPasswordsController
  #edit
    no user matches token
      redirects to page where user enters email for password reset token
    token is valid
      displays the form to enter a new password and disallows indexing
    token expired
      redirects to page where user enters email for password reset token
  #new
    logs visit to analytics
  #create
    renders new if email is nil
    renders new if email is a Hash
    user is verified
      captures in analytics that the user was verified
    user exists
      sends password reset email to user and tracks event
    email is invalid
      displays an error and tracks event
    user exists but is unconfirmed
      sends password reset email to user and tracks event
    no user matches email
      send an email to tell the user they do not have an account yet
  #update
    ial2 user submits valid new password
      deactivates the active profile and redirects
    user submits invalid new password
      renders edit
    user submits the reset password form twice
      shows an invalid token error
    unconfirmed user submits valid new password
      confirms the user
    user submits new password after token expires
      redirects to page where user enters email for password reset token
    IAL1 user submits valid new password
      redirects to sign in page

Idv::InPerson::ReadyToVerifyController
  #show
    renders not found
    with in person proofing enabled
      redirects to account page
      with enrollment
        logs analytics
        renders show template
  before_actions
    includes authentication before_action

Idv::GpoController
  before_actions
    includes authentication before_action
    includes before_actions from IdvSession
  #index
    redirects if the user has sent too much mail
    assigns the current step indicator step as "verify phone or address"
    allows a user to request another letter
    renders confirmation page
    resending a letter
      assigns the current step indicator step as "get a letter"
    with letter already sent
      logs visited event
  #create
    resending a letter
      redirects to capture password if pii is locked
      logs attempts api tracking
      calls the GpoConfirmationMaker to send another letter and redirects
      calls GpoConfirmationMaker to send another letter with reveal_gpo_code on
    first time through the idv process
      sets session to :gpo and redirects
      logs attempts api tracking

Redirect::ReturnToSpController
  #cancel
    when there is an SP request in the session
      redirects to the redirect URI in the request url
    when there is an SP in the session without a request url
      redirects to the configured request url
    when there is no SP
      redirects to the account
    when there is a SP request url for the request id param
      redirects to the redirect URI in the request url
  #failure_to_proof
    when there is no SP
      redirects to the account
    with step or location parameters
      logs with extra analytics properties
    when there is an SP in the session
      redirects to the SP

AccountsController
  before_actions
    includes before_actions from AccountStateChecker
  #show
    when a profile has been deactivated by password reset
      renders the profile and shows a deactivation banner
    when a profile is pending
      renders the pending profile banner
    when logging in with piv/cac
      when the user is proofed
        renders a locked profile
    when user has an active identity
      renders the profile and does not redirect out of the app

MfaConfirmationController
  #show
    presents the mfa confirmation page.
  password attempts counter
    max password attempts reached
      signs the user out
    last password attempt is correct
      does not sign the user out
  #new
    presents the password confirmation form
    does not reset password attempts if already set
  #create
    password is empty
      redirects with error message and increments password attempts
    password is wrong
      redirects with error message and increments password attempts
      session data is missing
        redirects and increments the password count
    password is correct
      redirects to 2FA and resets password attempts

OpenidConnect::UserInfoController
  #show
    with an invalid bearer token
      401s
      tracks analytics
    without an authorization header
      401s
      tracks analytics
    with a malformed authorization header
      401s
      tracks analytics
    with a valid bearer token
      renders user info
      tracks analytics
      only changes the paths visited in session

SamlCompletionController
  GET #index
    with a blank service provider request session
      renders 404 not found
    with a nil service provider request session
      renders 404 not found
    with a valid service provider request session
      renders the appropriate form

PasswordCaptureController
  #update
    form returns success
      decrypts PII and redirects
    form errors
      increases password attempts

Health::DatabaseController
  #index
    when the database is healthy
      is a 200
      renders the result
    when the database is unhealthy
      is a 500
      renders the error

VerifySpAttributesConcern
  #consent_has_expired?
    when there is an active profile
      when the active profile was verified after last_consented_at
        is true because the new verified data needs to be consented to sharing
      when the active profile was verified before last_consented_at
        is false
    when last_consented_at within one year
      is false
    when last_consented_at is nil but created_at is within a year
      is false
    when there is no last_consented_at
      is true
    when there is no sp_session_identity
      is false
    when last_consented_at is nil and created_at is older than a year
      is true
    when the identity has been soft-deleted (consent has been revoked)
      is false
    when the last_consented_at is older than a year ago
      is true
  #consent_was_revoked?
    when the sp_session_identity exists and has been deleted
      is false
    when the sp_session_identity exists and has not been deleted
      is false
    when there is no sp_session_identity
      is false
  #needs_completion_screen_reason
    with an issuer
      when the sp_session_identity has been saved
        when requested attributes are verified
          is nil
        when requested attributes exist and are not verified
          is :new_attributes
        when requested attributes are nil
          is nil
      when the sp_session_identity has not been saved
        is :new_sp
    without an issuer
      is nil

SignOutController
  #destroy
    redirects to decorated_session.cancel_link_url with flash message
    calls #sign_out and #delete_branded_experience
    tracks the event

AccountReset::ConfirmDeleteAccountController
  #show
    no email in session
      redirects to the new user registration path
    email in session
      renders the page and deletes the email from the session

OpenidConnect::AuthorizationController
  #index
    user is not signed in
      sets sp information in the session and does not transmit ial2 attrs for ial1
      redirects to SP landing page with the request_id in the params
      without valid acr_values
        handles the error and does not blow up
      with a bad redirect_uri
        renders the error page
      with an inherited_proofing_auth code
        persists the inherited_proofing_auth value
        redirects to SP landing page with the request_id in the params
    user is signed in
      with invalid params that mean the redirect_uri is not trusted
        tracks the event with errors
        renders the error page
      with valid params
        redirects back to the client app with a code
        tracks IAL1 authentication event
        with ial2 requested
          account is not already verified
            redirects to have the user verify their account
          profile is reset
            redirects to have the user enter their personal key
          account is already verified
            redirects to the password capture url when pii is locked
            redirects to the redirect_uri immediately when pii is unlocked
            tracks IAL2 authentication event
        user has not approved this application
          does not link identity to the user
          redirects verify shared attributes page
        with ialmax requested
          account is not already verified
            redirects to the redirect_uri immediately without proofing
            tracks IAL1 authentication event
          account is already verified
            tracks IAL2 authentication event
            redirects to the password capture url when pii is locked
            redirects to the redirect_uri immediately when pii is unlocked
          profile is reset
            redirects to the redirect_uri immediately without proofing
            tracks IAL1 authentication event
        user has already approved this application
          redirects back to the client app with a code
      with invalid params that do not interfere with the redirect_uri
        tracks the event with errors
        redirects to the redirect_uri immediately with an invalid_request

Idv::PhoneController
  before_actions
    includes authentication before_action
  #create
    when form is valid
      tracks event with valid phone
      tracks events with valid phone
      when same as user phone
        redirects to otp delivery page
        with full vendor outage
          redirects to vendor outage page
      when different phone from user phone
        redirects to otp page and does not set phone_confirmed_at
        with full vendor outage
          redirects to vendor outage page
    when verification fails
      tracks event with invalid phone
      renders failure page and does not set phone confirmation
      when the user is throttled by submission
        tracks throttled event
    when form is invalid
      renders #new
      disallows non-US numbers
      tracks form error events and does not make a vendor API call
  before_actions
    includes before_actions from IdvSession
  #new
    shows phone form if async process times out and allows successful resubmission
    shows waiting interstitial if async process is in progress
    when the phone number has not been confirmed as user 2FA phone
      renders the form
    when the user has chosen to use a different number
      logs an event showing that the user wants to choose a different number
    when the user is throttled
      redirects to fail
    when the phone number has been confirmed as user 2FA phone
      redirects to review when step is complete

Idv::PhoneOtpRateLimitable
  #handle_too_many_otp_sends
    calls analytics tracking event
    calls irs tracking event idv_phone_otp_sent_rate_limited

ReauthnRequiredController
  #confirm_recently_authenticated
    recently authenticated
      allows action
    authenticated outside the authn window
      sets context to authentication
      redirects to password confirmation

TwoFactorAuthentication::PersonalKeyVerificationController
  #show
    tracks the page visit
    redirects to the two_factor_options page if user is IAL2
    when there is no session (signed out or locked out), and the user reloads the page
      redirects to the home page
  #create
    does generate a new personal key after the user signs in with their old one
    does not generate a new personal key if the user enters an invalid key
    redirects to the two_factor_options page if user is IAL2
    when the user enters a valid personal key
      tracks the valid authentication event
    when the user enters an invalid personal key
      re-renders the personal key entry screen
      tracks the max attempts event
      calls handle_invalid_otp
    when the personal key field is empty
      renders the show page

Users::VerifyPasswordController
  with password reset profile
    with personal key flag set
      #new
        renders the `new` template
      #update
        with valid password
          redirects to the account page
          sets a new personal key as a flash message
        without valid password
          renders the new template
    without personal key flag set
      #update
        redirects to the root url
      #new
        redirects to the root url
  without password_reset_profile
    #new
      redirects user to the home page

VendorOutageController
  sets show_gpo_option view variable
  tracks an analytics event
  from idv phone
    gpo letter available
      sets show_gpo_option as true

AccountReset::RequestController
  #show
    redirects to root if user not signed in
    logs the visit to analytics
    redirects to 2FA setup url if 2FA not set up
    renders the page
  #create
    logs the visit to attempts api
    logs sms user in the analytics
    redirects to root if user not signed in
    logs totp user in the analytics
    redirects to 2FA setup url if 2FA not set up
    logs PIV/CAC user in the analytics

Users::WebauthnSetupController
  when signed in and account creation
    Multiple MFA options turned off
      with a single MFA method chosen
        should direct user to second mfa suggestion page
    Multiple MFA options turned on
      with multiple MFA methods chosen on account creation
        should direct user to next method confirmation page
      with a single MFA method chosen on account creation
        should direct user to second mfa suggestion page
      with attestation response error
        should log expected events
      with only webauthn_platform chosen on account creation
        should log expected events
      with multiple MFA methods chosen on account creation
        should log expected events
  when signed in and not account creation
    patch confirm
      tracks the submission
    delete
      creates a webauthn key removed event
      sends a recovery information changed event
      tracks the delete in analytics
    GET new
      tracks page visit
    show_delete
      redirects when the configuration does not exist
      renders page when configuration exists
  when not signed in
    GET new
      redirects to root url
    patch confirm
      redirects to root url
  before_actions
    includes appropriate before_actions

Test::PushNotificationController
  #destroy
    clears events and redirects to index
  #index
    sets @events and renders
    404s in production

TwoFactorAuthentication::OptionsController
  #index
    logs an analytics event
    renders the page
  #create
    redirects to login_two_factor_authenticator_url if user selects auth_app
    tracks analytics event
    redirects to login_two_factor_webauthn_url if user selects webauthn
    redirects to login_two_factor_webauthn_url with param if user selects platform auth
    sets phone_id in session when selecting a phone option
    redirects to login_two_factor_piv_cac_url if user selects piv_cac
    redirects to login_two_factor_url if user selects sms
    rerenders the page with errors on failure
    redirects to login_two_factor_url if user selects voice

Test::TelephonyController
  #destroy
    clears messages and calls and redirects to index
  #index
    sets @messages and @calls and renders
    404s in production

SignUp::RegistrationsController
  #new
    gracefully handles invalid formats
    allows user to visit the sign up page
    cannot be viewed by signed in users
  #create
    tracks unsuccessful user registration
    renders new if email is a Hash
    renders new if request_id is blank
    renders new if email is nil
    tracks successful user registration with existing email
    when registering with a new email
      sets the users preferred email locale and sends an email in that locale
      cannot be accessed by signed in users
      sets the email in the session and redirects to sign_up_verify_email_path
      tracks successful user registration

TwoFactorAuthentication::OtpVerificationController
  #show
    redirects to phone setup page if user does not have a phone yet
    tracks the page visit and context
    when resource is not fully authenticated yet
      when FeatureManagement.prefill_otp_codes? is true
        sets code_value on presenter to correct OTP value
      when FeatureManagement.prefill_otp_codes? is false
        does not set @code_value
      when the user has an invalid phone number in the session
        redirects to homepage
    when there is no session (signed out or locked out), and the user reloads the page
      redirects to the home page
  #create
    when the user lockout period expires
      when user submits an invalid OTP
        resets attempts count
        resets second_factor_locked_at
      when user submits a valid OTP
        resets second_factor_locked_at
        resets attempts count
    when the user enters an invalid OTP during reauthentication context
      increments second_factor_attempts_count
    when the user enters an invalid OTP during authentication context
      increments second_factor_attempts_count
      displays flash error message
      redirects to the OTP entry screen
    phone confirmation
      with remember_device in the params
        saves an encrypted cookie
      user has an existing phone number
        user enters a valid code
          tracks the update event and notifies via email about number change
          resets otp session data
        user does not include a code parameter
          fails and increments attempts count
        user enters an invalid code
          does not clear session data
          displays error flash notice
          renders :show
          does not update user phone or phone_confirmed_at attributes
          increments second_factor_attempts_count
          tracks an event
          user has exceeded the maximum number of attempts
            tracks the attempt event
      when user does not have an existing phone number
        Feature flag #select_multiple_mfa_options is true
          one MFA option selected
            redirects to auth_confirmation page
          multiple MFA options selected
            redirects to next mfa method with backup code next
        when given valid code
          redirects to profile page
          resets context to authentication
          tracks the confirmation event
      without remember_device in the params
        does not save an encrypted cookie
    when the user enters a valid OTP
      tracks the valid authentication event
      tracks the attempt event with reauthentication parameter true
      resets the second_factor_attempts_count
      redirects to the profile
      with remember_device in the params
        saves an encrypted cookie
      without remember_device in the params
        does not save an encrypted cookie
    when the user has reached the max number of OTP attempts
      tracks the event

AccountReset::CancelController
  #create
    signs the user out if signed in and if the token is valid
    redirects to the root with a flash message when the token is valid
    logs a good token to the analytics
    logs a bad token to the analytics
    redirects to the root without a flash message when the token is missing or invalid
    logs a missing token to the analytics
  #show
    renders the show view if the token is missing
    redirects to root if the token does not match one in the DB

TwoFactorAuthentication::TotpVerificationController
  #show
    when the user does not have an authenticator app enabled
      redirects to user_two_factor_authentication_path
    when the user has an authenticator app enabled
      sets view assigns
      logs the visited event
      when FeatureManagement.prefill_otp_codes? is true
        sets view assigns
  #create
    when the user does not have an authenticator app enabled
      redirects to user_two_factor_authentication_path
    when the user enters an invalid TOTP
      increments second_factor_attempts_count
      displays flash error message
      re-renders the TOTP entry screen
    when the user enters a valid TOTP
      resets the second_factor_attempts_count
      redirects to the profile
      tracks the valid authentication event
    when the user lockout period expires
      when user submits an invalid TOTP
        resets attempts count
        resets second_factor_locked_at
      when user submits an invalid form
        fails with empty code
        fails with no code parameter
      when user submits a valid TOTP
        resets attempts count
        resets second_factor_locked_at
    when the user has reached the max number of TOTP attempts
      tracks the event

Users::PhonesController
  phone vendor outage
    redirects to outage page
  user exceeds phone number limit
    defaults to account url if the url is anything but two factor auth url
    it redirects to two factor auth url if the referer was two factor auth
    renders the #phone anchor when it exceeds limit
    displays error if phone number exceeds limit
  user adds phone
    gives the user a form to enter a new phone number

AccountReset::PendingController
  #cancel
    cancels the account reset request and logs the cancellation event
    when the account reset request does not exist
      renders a 404
  #show
    when the account reset request does not exist
      renders a 404

Idv::PhoneErrorsController
  #jobfail
    with throttle attempts
      assigns remaining count
      logs an event (FAILED - 2)
    behaves like an idv phone errors controller action
      the user is not authenticated and not recovering their account
        redirects to sign in
      the user is authenticated and has not confirmed their phone
        renders the error
      before_actions
        includes before_actions from IdvSession
      the user is authenticated and has confirmed their phone
        redirects to the review url
  #warning
    with throttle attempts
      logs an event (FAILED - 3)
      assigns remaining count
    behaves like an idv phone errors controller action
      the user is authenticated and has not confirmed their phone
        renders the error
      before_actions
        includes before_actions from IdvSession
      the user is not authenticated and not recovering their account
        redirects to sign in
      the user is authenticated and has confirmed their phone
        redirects to the review url
  #timeout
    behaves like an idv phone errors controller action
      before_actions
        includes before_actions from IdvSession
      the user is authenticated and has not confirmed their phone
        renders the error
      the user is not authenticated and not recovering their account
        redirects to sign in
      the user is authenticated and has confirmed their phone
        redirects to the review url
    with throttle attempts
      assigns remaining count
  #failure
    while throttled
      logs an event
      assigns expiration time
    behaves like an idv phone errors controller action
      the user is authenticated and has confirmed their phone
        redirects to the review url
      the user is authenticated and has not confirmed their phone
        renders the error
      before_actions
        includes before_actions from IdvSession
      the user is not authenticated and not recovering their account
        redirects to sign in

PagesController
  analytics
    returns 404 status
    does not load session
    renders without a layout
  content expiry
    does not set headers to disable cache

Idv::OtpVerificationController
  before_actions
    includes before_actions from IdvSession
  #update
    tracks an analytics event
    the user has not been sent an otp
      redirects to otp delivery method selection
    track irs analytics event
      when the phone otp code is invalid
        captures failure event
      when the phone otp code is valid
        captures success event
    the user has already confirmed their phone
      redirects to the review step
  #show
    tracks an analytics event
    the user has already confirmed their phone
      redirects to the review step
    the user has not been sent an otp
      redirects to the delivery method path

AnalyticsEventsController
  #index
    when the JSON file does not exist
      404s
    when the JSON file exists
      renders the file

Users::PivCacAuthenticationSetupController
  when signed out
    GET index
      redirects to sign in page
  when signing in
    GET index
      redirects to 2fa entry
    DELETE delete
      redirects to root url
  when not signed in
    DELETE delete
      redirects to root url
    GET index
      redirects to root url
  when signed in
    with associated piv/cac
      DELETE delete
        removes the piv/cac association
        resets the remember device revocation date/time
        sends a recovery information changed event
        removes the piv/cac information from the user session
        redirects to account page
        does not remove the piv/cac association if it is the last mfa method
      GET index
        does not redirect to account page because we allow multiple PIV/CACs
    without associated piv/cac
      GET index
        when redirected with an error token
          renders the error template
          resets the piv/cac session information
        when redirected with a good token
          with multiple MFA options feature toggle on
            with no additional MFAs chosen on setup
              sets the piv/cac session information
              redirects to suggest 2nd MFA page
              sets the session to not require piv setup upon sign-in
            with additional MFAs leftover
              sets the piv/cac session information
              sets the session to not require piv setup upon sign-in
              redirects to Mfa Confirmation page
          with multiple MFA options feature toggle off
            with no additional MFAs chosen on setup
              redirects to suggest account page
              sets the piv/cac session information
              sets the session to not require piv setup upon sign-in
        when rendered without a token
          renders the "new" template
      DELETE delete
        redirects to account 2FA page

Risc::ConfigurationController
  #index
    renders information about the RISC profile

AccountReset::DeleteAccountController
  #show
    renders the show view if the token is missing
    displays a flash and redirects to root if the token is expired
    redirects to root if the token does not match one in the DB
  #delete
    logs a good token to the attempts api
    logs a good token to the analytics
    redirects to root if the token does not match one in the DB
    displays a flash and redirects to root if the token is expired
    logs an error in irs attempts tracker
    displays a flash and redirects to root if the token is missing

ServiceProviderController
  #update
    incorrect token in header
      returns a 401
    feature on, correct token in headers
      returns 200
      updates the matching ServiceProvider in the DB
      with CSRF protection enabled
        ignores invalid CSRF tokens

Idv::ThreatMetrixConcern
  #override_csp_for_threat_metrix
    ff is set
      modifies CSP headers for SSN step
      does not modify CSP headers for any other step
    ff is not set
      does not modify CSP headers for SSN step
      does not modify CSP headers for any other step

Idv::DocumentCaptureConcern
  #override_document_capture_step_csp
    does not set headers for any other step
    sets the headers for the document capture step

Users::VerifyPersonalKeyController
  #new
    without password_reset_profile
      redirects user to the home page
    with password reset profile
      displays a flash message to the user
      shows throttled page after being throttled
      renders the `new` template
    with throttle reached
      renders throttled page
  before actions
    only allows 2fa users through
  #create
    with an invalid form
      tracks irs attempts api for relevant users
      sets an error in the flash
      redirects to form
    with throttle reached
      tracks irs attempts api for relevant users
      renders throttled page
    with a valid form
      stores that the personal key was entered in the user session
      redirects to the next step of the account recovery flow
      tracks irs attempts api for relevant users

Users::TwoFactorAuthenticationSetupController
  PATCH create
    submits the TwoFactorOptionsForm
    tracks analytics event
    tracks IRS attempts event
    when multi selection with auth app first
      redirects properly
    when the selection is auth_app
      redirects to authentication app setup page
    when the selection is piv_cac
      redirects to piv/cac setup page
    when the selection is webauthn
      redirects to webauthn setup page
    when the selection is webauthn platform authenticator
      redirects to webauthn setup page with the platform param
    when the selection is not valid
      renders index page
    when the selection is only phone and multi mfa is enabled
      contains a flash message
      the redirect to the form page with an anchor
    when multi selection with phone first
      redirects properly
  GET index
    tracks the visit in analytics
    when signed out
      redirects to sign in page
    when fully authenticated and MFA enabled
      loads the account page
    when fully authenticated but not MFA enabled
      allows access
    already two factor enabled but not fully authenticated
      prompts for 2FA

Idv::InPerson::AddressSearchController
  #index
    with successful fetch
      gets successful response
      with no suggestions
        returns empty array
    with feature disabled
      renders 404
    with unsuccessful fetch
      gets an empty pilot response

SamlPostController
  POST /api/saml/auth
    does not render extra parameters
    renders the appropriate form

SignUp::CancellationsController
  #new
    tracks the event in analytics when referer is nil
    tracks the event in analytics when referer is present
  #destroy
    tracks the event in analytics when referer is present
    redirects to the branded start page if the user came from an SP
    redirects if confirmation_token is invalid
    redirects if confirmation_token is expired
    tracks the event in analytics when referer is nil
    redirects if no user is present
    destroys the current_user if user has set password but not added 2FA
    calls ParseControllerFromReferer
    redirects if user has completed sign up

Users::TotpSetupController
  #new
    user is setting up authenticator app after account creation
      sets new_totp_secret in user_session
      captures an analytics event
      returns a 200 status code
      can be used to generate a qrcode with UserDecorator#qrcode
    user is setting up authenticator app during account creation
      captures an analytics event
      can be used to generate a qrcode with UserDecorator#qrcode
      sets new_totp_secret in user_session
      returns a 200 status code
  #confirm
    user is not yet signed up
      when totp secret is no longer in user_session
        redirects with an error message
      when user presents correct code
        when user has multiple MFA methods left in user session
          redirects to next mfa path with a success message and still logs analytics
        when user selected only one method on account creation
          redirects to auth method confirmation path with a success message
      when user presents invalid code
        redirects with an error message
    user is already signed up
      when user presents invalid code
        redirects with an error message
      when user omits name
        redirects with an error message
      when user presents nil code
        redirects with an error message
      when user presents correct code
        redirects to account_path with a success message
  before_actions
    includes appropriate before_actions
  #disable
    when totp is the last mfa method
      does not disable totp
    when a user has configured TOTP
      disables TOTP

Users::RulesOfUseController
  before_actions
    includes appropriate before_actions
  #new
    with a user who is up to date with rules of use
      redirects to mfa
    with no user signed in
      redirects to root
    with a user that has not accepted the rules of use
      renders
      logs an analytics event for visiting
    with a user that has accepted the rules of use
      redirects to mfa
    with a user who is not up to date with rules of use
      logs an analytics event for visiting
      renders
  #create
    when the user needs to accept the rules of use and does accept them
      logs a successful analytics event
      updates the user accepted terms at timestamp
      redirects to the two factor authentication page
    when the user needs to accept the rules of use and does not accept them
      logs a failure analytics event
      redirects to the two factor authentication page
      does not updates the user accepted terms at timestamp

Idv::InheritedProofingController
  when VA inherited proofing mock is not enabled
    behaves like the flow steps work correctly
      #show
        renders the correct template
        redirects to the first step if a non-existent step is given
        redirects to the configured next step
      #index
        redirects to the first step
        when the inherited proofing feature flag is disabled
          returns 404 not found
  when VA inherited proofing mock is enabled
    behaves like the flow steps work correctly
      #index
        redirects to the first step
        when the inherited proofing feature flag is disabled
          returns 404 not found
      #show
        renders the correct template
        redirects to the configured next step
        redirects to the first step if a non-existent step is given

Users::AdditionalMfaRequiredController
  #skip
    after enforcement date, user has not skipped yet
      does not allow unauthenticated users
      should redirect user to sign in
      should add sign in attribute to users
    before enforcement date
      should redirect to user signin
  #show
    presents the additional mfa required prompt page.
    does not allow unauthenticated users

Test::DeviceProfilingController
  #index
    sets no_result for the session_id
  #create
    sets the result in redis

Users::EmailLanguageController
  #show
    logs an analytics event for visiting
    renders
  #update
    with an invalid language selection
      redirects to the account page, no success flash
      does not change the user email_language
      logs an unsuccessful analytics event
    with a valid language selection
      logs a successful analytics event
      updates the user email_language
      redirects to the account page with a success flash
  before_actions
    includes appropriate before_actions

Health::HealthController
  #index
    all resources are unhealthy
      returns an unsuccessful JSON response
    when all checked resources are healthy
      returns a successful JSON response
    when one resource is unhealthy
      returns an unsuccessful JSON response

Test::FakeS3Controller
  #show
    with an unknown key
      404s
    with a valid key
      is that data
  #update
    stores the data in memory

CountrySupportController
  #index
    sets HTTP headers to cache for 15 minutes
    renders country support as JSON
    renders when passing in different locale
      renders country support with localization support

Users::EditPhoneController
  #update
    when the user submits a valid otp delivery preference
      updates the phone configuration and redirects
    when the user submits an invalid delivery preference
      renders the edit screen
  #destroy
    deletes the phone configuration
    when the user will not have enough phone configurations after deleting
      does not delete the phone configuration

SignUp::EmailConfirmationsController
  Two users simultaneously confirm email with race condition
    does not throw a 500 error
  Valid email confirmation tokens
    tracks a valid email confirmation token event
  #create
    tracks nil email confirmation token
    tracks confirmation token as a single-quoted empty string
    tracks blank email confirmation token
    tracks blank confirmation_sent_at as expired token
    tracks confirmation token as a double-quoted empty string
    tracks already confirmed token
    tracks expired token

OpenidConnect::ConfigurationController
  #index
    sets HTTP headers to cache for a week
    renders information about the OpenID Connect integration

AccountReset::RecoveryOptionsController
  #cancel
    logs the visit to analytics
    redirects to 2FA options page
  #show
    renders the page
    logs the visit to analytics
    redirects to root if user not signed in

NoJsController
  #index
    returns empty css
    assigns session key

Api::IrsAttemptsApiController
  #create
    returns an error without required timestamp parameter
    authenticates the client
    renders a 404 if disabled
    renders encrypted events
    returns an error with invalid timestamp parameter
    returns an error with empty timestamp parameter
    with a timestamp including a fractional second
      accepts the timestamp as valid
    with CSRF protection enabled
      allows authentication without error

IdvController
  #index
    redirects to doc auth if doc auth is enabled and exclusive
    tracks page visit
    redirects to account recovery if user has a password reset profile
    does not track page visit if profile is active
    redirects to failure page if number of attempts has been exceeded
    no SP context
      sp not required
        begins the identity proofing process
      sp required
        redirects back to the account page
        user has an existing profile
          begins the identity proofing process
    with a VA inherited proofing session
      redirects to inherited proofing
  #activated
    user does not have an active profile
      does not allow direct access
    user has an active profile
      allows direct access

TwoFactorAuthentication::BackupCodeVerificationController
  #create
    when the backup code field is empty
      renders the show page
    when the user enters an invalid backup code
      tracks the max attempts event
      re-renders the backup code entry screen
    when the user enters a valid backup code
      tracks the valid authentication event
      tracks the valid authentication event when there are exisitng codes
  #show
    tracks the page visit

OpenidConnect::CertsController
  #index
    renders the server public key as a JWK set
    sets HTTP headers to cache for a week

Idv::ComeBackLaterController
  user needs USPS address verification
    renders the show template
  user does not need USPS address verification
    redirects to the account path

Idv::CaptureDocController
  #index
    with a good session uuid
      redirects to the first step
    with an expired token
      redirects to the root url
    with a user id in session and no session uuid
      redirects to the first step
    with a bad session
      redirects to the root url
    with no session
      redirects to the root url
  before_actions
    includes corrects before_actions
  #show
    with a user id in session
      increments the analytics step counts on subsequent submissions
      renders the document_capture template
      renders a 404 with a non existent step
      tracks expected events for irs reproofing
      tracks expected events
      renders the capture_complete template

InheritedProofingConcern
  #inherited_proofing?
    when inherited proofing proofing is not effect
      returns false
    when inherited proofing proofing is effect
      returns true
  #va_inherited_proofing?
    when the va auth code is not present
      returns false
    when the va auth code is present
      returns true
  #va_inherited_proofing_auth_code_params_key
    returns the correct va auth code url query param key
  #inherited_proofing_service_provider_data
    when there is a va inherited proofing request
      returns the correct service provider-specific data
    when the inherited proofing request cannot be identified
      returns an empty hash
  #inherited_proofing_service_provider
    when a service provider cannot be identified
      returns nil
    when a service provider can be identified
      returns the service provider

Users::PersonalKeysController
  #show
    tracks the page visit when there is a personal key in the user session
    does not generate a new personal key to avoid CSRF attacks
    tracks the page visit when there is no personal key in the user session
    when user signed in but user_session[:personal_key] is not present
      redirects to account_url
    when there is no session (signed out or locked out), and the user reloads the page
      redirects to the home page
  #update
    deletes user_session[:personal_key]
    tracks CSRF errors
    user does not need to reactivate account
      redirects to the profile page
    user needs to reactive account
      redirects to the reactivate account url for ial 2
      redirects to the sign up completed url for ial 1

Redirect::HelpCenterController
  #show
    with valid help center article
      redirects to the help center article and logs
      with location params
        logs with location params
    without help center article
      redirects to the root url
    with invalid help center article
      redirects to the root url

Users::DeleteController
  #delete
    does not delete identities to prevent uuid reuse
    deletes user
    logs a succesful submit
    redirects to the root path
    deletes profile information for ial2
    with an incorrect password
      logs a failed submit
      does not delete the user
      flashes a banner and renders the form
  #show
    shows and logs a visit

Idv::InPerson::UspsLocationsController
  #update
    writes the passed location to in-person enrollment
    with feature disabled
      renders 404
    with hybrid user
      writes the passed location to in-person enrollment associated with effective user
    with associated service provider
      assigns services provider to in-person enrollment
    when unauthenticated
      renders an unauthorized status
  #index
    with successful fetch
      gets successful pilot response
    with unsuccessful fetch
      gets an empty pilot response
    with feature disabled
      renders 404

Users::TwoFactorAuthenticationController
  before_actions
    includes the appropriate before_actions
  #send_code
    when selecting SMS OTP delivery
      calls OtpRateLimiter#exceeded_otp_send_limit? and #increment
      tracks the analytics events
      marks the user as locked out after too many attempts
      tracks the attempt event when user session context is reauthentication
      sends OTP via SMS for sign in
      tracks the verification attempt event
      when the phone has been marked as opted out in the DB
        does not send an OTP
      when Pinpoint throws an opt-out error
        redirects to the opt in controller
    when selecting an invalid delivery method
      redirects user to choose a valid delivery method
    when selecting voice OTP delivery
      tracks the event
      sends OTP via voice
      redirects to two factor options path with invalid id
    phone is not confirmed
      rate limits confirmation OTPs when adding number to existing account
      marks the user as locked out after too many attempts on sign up
      flashes an sms error when the telephony gem responds with an sms error
      sends OTP inline when confirming phone
      tracks the enrollment attempt event
      rate limits confirmation OTPs on sign up
  #show
    when the user has not already set up 2FA
      redirects to set up 2FA
    when SP requires PIV/CAC
      redirects to MFA setup if no PIV/CAC is enabled
    when there is no session (signed out or locked out), and the user reloads the page
      redirects to the home page
    when user is authenticated with a remembered device via phone
      does redirect to sms if reauthn parameter is true
      does redirect to the profile
    when user is webauthn enabled
      passes reauthn parameter on redirect
      renders the :webauthn view
      passes the platform parameter if the user has a platform autheticator
    when user is piv/cac enabled
      renders the piv/cac entry screen
    when the user has already set up 2FA
      sends OTP via otp_delivery_preference and prompts for OTP
      when no options are enabled and available for use
        redirects to mfa options page
    when user has backup codes
      renders the :backup_code view
      passes reauthn parameter on redirect
    when user is TOTP enabled
      passes reauthn parameter on redirect
      renders the :confirm_totp view
    when phone is sole configured mfa and full phone vendor outage
      redirects to vendor outage page
  #check_already_authenticated
    when the user is fully authenticated and the context is authentication
      redirects to the profile
    when the user is not fully signed in
      does not redirect to the profile
    when the user is fully authenticated and the context is not authentication
      does not redirect to the profile

Idv::ResendOtpController
  #create
    tracks an analytics event
    Telephony raises an exception
      tracks an analytics events
    the user has not selected a delivery method
      redirects to otp delivery method selection
    the user has already confirmed their phone
      redirects to the review step
  before_actions
    includes before_actions from IdvSession

OpenidConnect::LogoutController
  when accepting id_token_hint and client_id
    #index
      when sending id_token_hint
        user is not signed in
          redirects back with an error
        user is signed in
          with a bad redirect URI
            tracks events
            renders an error page
            does not destroy the session
          with a bad id_token_hint
            tracks events
          with valid params
            tracks events
            redirects back to the client
            destroys the session
      when sending client_id
        user is not signed in
          redirects back to client
        user is signed in
          with valid params
            renders logout confirmation page
          with a bad redirect URI
            tracks events
            renders an error page
            does not destroy the session
    #delete
      when sending client_id
        user is signed in
          destroys the session
        user is not signed in
          destroys the session
      when sending id_token_hint
        user is signed in
          destroys the session
        user is not signed in
          destroys the session
  when rejecting id_token_hint
    #index
      user is signed in
        with an id_token_hint
          renders an error page
          tracks events
          does not destroy the session
        with a bad redirect URI
          does not destroy the session
          tracks events
          renders an error page
        with valid params
          renders logout confirmation page
          tracks events
      user is not signed in
        redirects back to client
    #delete
      when sending id_token_hint
        user is signed in
          destroys the session
        user is not signed in
          destroys the session
      when sending client_id
        user is signed in
          tracks events
          destroys the session
        user is not signed in
          destroys the session

TwoFactorAuthentication::SmsOptInController
  #create
    when loaded while using an existing phone
      when resubscribing is successful
        redirects to the otp send controller
        deletes the opt out row
      when resubscribing throws an error
        does not delete the opt out row
        renders the form with a flash error
      when resubscribing is not successful
        does not delete the opt out row
        renders an error
    when loaded without any phone context
      renders a 404
  #new
    when loaded without any phone context
      renders a 404
    when loaded while using an existing phone
      tracks a visit event
      when the user is signing in through an SP
        points the cancel link back to the SP
      when the user has other auth methods
        has an other mfa options url
    when loaded while adding a new phone
      assigns an in-memory phone configuration

Users::EmailConfirmationsController
  #create
    Valid email confirmation tokens
      rejects expired tokens
      rejects invalid tokens
      rejects an otherwise valid token for unconfirmed users
      tracks a valid email confirmation token event

SignUp::EmailsController
  #show
    email in session
      renders the page and deletes the email from the session
    no email in session
      redirects to the new user registration path

Idv::OtpDeliveryMethodController
  #new
    tracks an analytics event
    user has confirmed phone number
      redirects to the review controller
    user has not completed phone step
      redirects to the phone controller
    user has not selected phone verification method
      redirects to the review controller
    user has selected phone verification and not confirmed phone
      renders
  before_actions
    includes before_actions from IdvSession
  #create
    form is invalid
      tracks appropriate events
      renders the new template
    user has not completed phone step
      redirects to the phone controller
    user has selected sms
      tracks appropriate events
      redirects to the otp send path for sms
    user has selected voice
      redirects to the otp send path for voice
      tracks appropriate events
    the telephony gem raises an exception
      tracks an analytics events
    user has confirmed phone number
      redirects to the review controller
    user has not selected phone verification method
      redirects to the review controller

IdvStepConcern
  #confirm_idv_session_started
    user has not started IdV session
      redirects to idv doc auth url
    user has started IdV session
      allows request
  #confirm_idv_needed
    user has active profile
      redirects to activated page
    user does not have active profile
      does not redirect to activated page

Failures:

  1) ApplicationController#cache_issuer_in_cookie with a current_sp sets sets the cookie sp_issuer
     Failure/Error: expect(cookie_expiration).to be_within(3.seconds).of(15.minutes.from_now)
       expected 2022-11-19 07:37:41.743374875 +1300 to be within 3 of 2022-11-19 05:22:41.747258036 +1300
     # ./spec/controllers/application_controller_spec.rb:53:in `block (4 levels) in <main>'

  2) Idv::PhoneErrorsController#jobfail with throttle attempts logs an event
     Failure/Error:
       expect(@analytics).to have_received(:track_event).with(
         'IdV: phone error visited',
         type: action,
         remaining_attempts: 4,
       )

       #<FakeAnalytics:0x000056478cb5a6b0 @events={}, @user=#<AnonymousUser:0x000056478cb5a660>> received :track_event with unexpected arguments
         expected: ("IdV: phone error visited", {:remaining_attempts=>4, :type=>:jobfail})
              got: ("IdV: phone error visited", {:remaining_attempts=>998, :type=>:jobfail})
       Diff:
       @@ -1 +1 @@
       -["IdV: phone error visited", {:remaining_attempts=>4, :type=>:jobfail}]
       +["IdV: phone error visited", {:remaining_attempts=>998, :type=>:jobfail}]
     # ./spec/controllers/idv/phone_errors_controller_spec.rb:131:in `block (4 levels) in <main>'

  3) Idv::PhoneErrorsController#warning with throttle attempts logs an event
     Failure/Error:
       expect(@analytics).to have_received(:track_event).with(
         'IdV: phone error visited',
         type: action,
         remaining_attempts: 4,
       )

       #<FakeAnalytics:0x000056478ce72bb8 @events={}, @user=#<AnonymousUser:0x000056478ce72b68>> received :track_event with unexpected arguments
         expected: ("IdV: phone error visited", {:remaining_attempts=>4, :type=>:warning})
              got: ("IdV: phone error visited", {:remaining_attempts=>998, :type=>:warning})
       Diff:
       @@ -1 +1 @@
       -["IdV: phone error visited", {:remaining_attempts=>4, :type=>:warning}]
       +["IdV: phone error visited", {:remaining_attempts=>998, :type=>:warning}]
     # ./spec/controllers/idv/phone_errors_controller_spec.rb:79:in `block (4 levels) in <main>'

Top 10 slowest examples (24.85 seconds, 14.4% of total time):
  MfaConfirmationController password attempts counter last password attempt is correct does not sign the user out
    9.84 seconds ./spec/controllers/mfa_confirmation_controller_spec.rb:126
  MfaConfirmationController password attempts counter max password attempts reached signs the user out
    6.51 seconds ./spec/controllers/mfa_confirmation_controller_spec.rb:101
  Idv::PhoneController#create when verification fails when the user is throttled by submission tracks throttled event
    2.46 seconds ./spec/controllers/idv/phone_controller_spec.rb:420
  AccountReset::DeleteAccountController#delete logs a good token to the analytics
    1.61 seconds ./spec/controllers/account_reset/delete_account_controller_spec.rb:12
  AccountReset::DeleteAccountController#delete logs a good token to the attempts api
    1 seconds ./spec/controllers/account_reset/delete_account_controller_spec.rb:37
  Users::EmailConfirmationsController#create Valid email confirmation tokens tracks a valid email confirmation token event
    0.80906 seconds ./spec/controllers/users/email_confirmations_controller_spec.rb:6
  Users::EmailConfirmationsController#create Valid email confirmation tokens rejects expired tokens
    0.77881 seconds ./spec/controllers/users/email_confirmations_controller_spec.rb:42
  TwoFactorAuthentication::PersonalKeyVerificationController#create does generate a new personal key after the user signs in with their old one
    0.65221 seconds ./spec/controllers/two_factor_authentication/personal_key_verification_controller_spec.rb:73
  Users::PasswordsController#update form returns success sends a security event
    0.64661 seconds ./spec/controllers/users/passwords_controller_spec.rb:52
  AccountReset::CancelController#create signs the user out if signed in and if the token is valid
    0.54706 seconds ./spec/controllers/account_reset/cancel_controller_spec.rb:74

Top 10 slowest example groups:
  MfaConfirmationController
    1.87 seconds average (16.82 seconds / 9 examples) ./spec/controllers/mfa_confirmation_controller_spec.rb:3
  Users::EmailConfirmationsController
    0.49026 seconds average (1.96 seconds / 4 examples) ./spec/controllers/users/email_confirmations_controller_spec.rb:3
  AccountReset::DeleteAccountController
    0.36189 seconds average (3.26 seconds / 9 examples) ./spec/controllers/account_reset/delete_account_controller_spec.rb:3
  Risc::SecurityEventsController
    0.26276 seconds average (1.05 seconds / 4 examples) ./spec/controllers/risc/security_events_controller_spec.rb:3
  Users::PasswordsController
    0.26093 seconds average (2.35 seconds / 9 examples) ./spec/controllers/users/passwords_controller_spec.rb:3
  Idv::PhoneController
    0.24909 seconds average (4.98 seconds / 20 examples) ./spec/controllers/idv/phone_controller_spec.rb:3
  Users::BackupCodeSetupController
    0.24095 seconds average (1.69 seconds / 7 examples) ./spec/controllers/users/backup_code_setup_controller_spec.rb:3
  SamlIdpController
    0.23605 seconds average (0.9442 seconds / 4 examples) ./spec/controllers/saml_signed_message_spec.rb:3
  AccountReset::RequestController
    0.20283 seconds average (2.03 seconds / 10 examples) ./spec/controllers/account_reset/request_controller_spec.rb:3
  Users::ResetPasswordsController
    0.19023 seconds average (3.23 seconds / 17 examples) ./spec/controllers/users/reset_passwords_controller_spec.rb:3

Finished in 2 minutes 52.9 seconds (files took 0.52387 seconds to load)
1356 examples, 3 failures

Failed examples:

rspec ./spec/controllers/application_controller_spec.rb:46 # ApplicationController#cache_issuer_in_cookie with a current_sp sets sets the cookie sp_issuer
rspec ./spec/controllers/idv/phone_errors_controller_spec.rb:128 # Idv::PhoneErrorsController#jobfail with throttle attempts logs an event
rspec ./spec/controllers/idv/phone_errors_controller_spec.rb:76 # Idv::PhoneErrorsController#warning with throttle attempts logs an event

Randomized with seed 33911



Randomized with seed 36668

TwoFactorAuthentication::PersonalKeyVerificationController
  #show
    tracks the page visit
    redirects to the two_factor_options page if user is IAL2
    when there is no session (signed out or locked out), and the user reloads the page
      redirects to the home page
  #create
    does not generate a new personal key if the user enters an invalid key
    redirects to the two_factor_options page if user is IAL2
    does generate a new personal key after the user signs in with their old one
    when the user enters a valid personal key
      tracks the valid authentication event
    when the user enters an invalid personal key
      tracks the max attempts event
      calls handle_invalid_otp
      re-renders the personal key entry screen
    when the personal key field is empty
      renders the show page

VendorOutageController
  tracks an analytics event
  sets show_gpo_option view variable
  from idv phone
    gpo letter available
      sets show_gpo_option as true

EventDisavowalController
  #create
    with an invalid disavowal_token
      tracks an analytics event
    with an invalid password
      tracks an analytics event
      assigns forbidden passwords
    with an event whose user has been deleted
      errors
    with a valid password
      tracks an analytics event
  #new
    with a valid disavowal_token
      assigns forbidden passwords
      tracks an analytics event
    with an invalid disavowal_token
      tracks an analytics event
      does not assign forbidden passwords

Risc::ConfigurationController
  #index
    renders information about the RISC profile

SamlPostController
  POST /api/saml/auth
    renders the appropriate form
    does not render extra parameters

RenderConditionConcern
  #index
    renders 404
    all feature enabled
      renders page
      show feature enabled
        renders page
  #show
    renders 404
    all feature enabled
      renders 404
      show feature enabled
        renders page
  with json response handling
    renders 404 api response

Api::Verify::BaseController
  #create
    renders as unauthorized (401)
    with authenticated user
      renders as ok (200)
      with request forgery protection enabled
        renders as ok (200)

Redirect::HelpCenterController
  #show
    without help center article
      redirects to the root url
    with valid help center article
      redirects to the help center article and logs
      with location params
        logs with location params
    with invalid help center article
      redirects to the root url

Users::PivCacAuthenticationSetupController
  when not signed in
    GET index
      redirects to root url
    DELETE delete
      redirects to root url
  when signing in
    GET index
      redirects to 2fa entry
    DELETE delete
      redirects to root url
  when signed out
    GET index
      redirects to sign in page
  when signed in
    without associated piv/cac
      GET index
        when redirected with a good token
          with multiple MFA options feature toggle on
            with additional MFAs leftover
              sets the piv/cac session information
              sets the session to not require piv setup upon sign-in
              redirects to Mfa Confirmation page
            with no additional MFAs chosen on setup
              redirects to suggest 2nd MFA page
              sets the piv/cac session information
              sets the session to not require piv setup upon sign-in
          with multiple MFA options feature toggle off
            with no additional MFAs chosen on setup
              sets the piv/cac session information
              redirects to suggest account page
              sets the session to not require piv setup upon sign-in
        when rendered without a token
          renders the "new" template
        when redirected with an error token
          resets the piv/cac session information
          renders the error template
      DELETE delete
        redirects to account 2FA page
    with associated piv/cac
      GET index
        does not redirect to account page because we allow multiple PIV/CACs
      DELETE delete
        removes the piv/cac association
        does not remove the piv/cac association if it is the last mfa method
        redirects to account page
        resets the remember device revocation date/time
        removes the piv/cac information from the user session
        sends a recovery information changed event

ApplicationController
  #cache_issuer_in_cookie
    without a current_sp
      clears the cookie sp_issuer
    with a current_sp
      sets sets the cookie sp_issuer
  #session_expires_at
    when URL contains the request_id parameter
      preserves the request_id parameter
    when URL contains the host parameter
      does not redirect to the host
    when URL does not contain the timeout parameter
      does not redirect anywhere
  #analytics
    when a current_user is not present
      calls the Analytics class with AnonymousUser.new and request parameters
    when a current_sp is not present
      does not perform a DB lookup
    when a current_user is present
      calls the Analytics class by default with current_user, request, and issuer
  #set_x_request_url
    sets the X-Request-URL header
  #sign_out
    deletes the ahoy_visit cookie when signing out
  #append_info_to_payload
    adds user_uuid and git metadata to the lograge output
  #confirm_two_factor_authenticated
    is 2FA-enabled
      prompts user to enter their OTP
    is not 2FA-enabled
      redirects to phone_setup_url with a flash message
    not signed in
      redirects to sign in page
  #redirect_on_timeout
    returns a 400 bad request when a url generation error is raised on the redirect
    when the current user is present
      does not display flash message
    when there is no current user
      displays a flash message
  #sp_session_request_url_with_updated_params
    leaves a nil url alone
    with a SAML request
      returns the saml completion url
    with saml_internal_post feature flag set to false
      when the locale has been changed
        adds the locale to the url
      with an OIDC request
        returns the original request
      with a SAML request
        returns the original request url
      with a url that has prompt=login
        changes it to prompt=select_account
    with an OIDC request
      returns the original request
    with a url that has prompt=login
      changes it to prompt=select_account
    when the locale has been changed
      adds the locale to the url
  #create_user_event
    when the user is specified
      creates an Event object for the specified user
    when the user is not specified
      creates an Event object for the current_user
  handling UnsafeRedirectError exceptions
    redirects back to home page
    tracks the Unsafe Redirect event and does not sign the user out
  handling RequestTimeoutException exceptions
    returns a proper status
    returns an html page
  #disable_caching
    sets headers to disable cache
  handling InvalidAuthenticityToken exceptions
    redirects back to home page if present and referer is invalid
    tracks the InvalidAuthenticityToken event and does not sign the user out
    redirects back to home page if present and referer is external
    redirects back to referer if present and is not external

Idv::PersonalKeyController
  before_actions
    includes before_actions from AccountStateChecker
    includes before_actions from IdvSession
    #confirm_profile_has_been_created
      profile has not been created
        redirects to the account path
      profile has been created
        does not redirect
  #show
    sets flash.now[:success]
    logs when user generates personal key
    sets code instance variable
    can decrypt the profile with the code
    sets flash[:allow_confirmations_continue] to true
  #update
    user selected gpo verification
      redirects to come back later path
      with in person profile
        creates a profile and returns completion url
    with device profiling decisioning enabled
      redirects to come back later path when device profiling fails
      redirects to account path when threatmetrix review status is nil
      redirects to account path when device profiling passes
    with in person profile
      creates a profile and returns completion url
    user selected phone verification
      redirects to sign up completed for an sp
      redirects to the account path when no sp present
      clears need_personal_key_confirmation session state

Users::EditPhoneController
  #destroy
    deletes the phone configuration
    when the user will not have enough phone configurations after deleting
      does not delete the phone configuration
  #update
    when the user submits an invalid delivery preference
      renders the edit screen
    when the user submits a valid otp delivery preference
      updates the phone configuration and redirects

Users::AdditionalMfaRequiredController
  #show
    does not allow unauthenticated users
    presents the additional mfa required prompt page.
  #skip
    after enforcement date, user has not skipped yet
      should redirect user to sign in
      does not allow unauthenticated users
      should add sign in attribute to users
    before enforcement date
      should redirect to user signin

AccountReset::CancelController
  #show
    renders the show view if the token is missing
    redirects to root if the token does not match one in the DB
  #create
    redirects to the root without a flash message when the token is missing or invalid
    logs a missing token to the analytics
    signs the user out if signed in and if the token is valid
    redirects to the root with a flash message when the token is valid
    logs a bad token to the analytics
    logs a good token to the analytics

Idv::OtpVerificationController
  #show
    tracks an analytics event
    the user has already confirmed their phone
      redirects to the review step
    the user has not been sent an otp
      redirects to the delivery method path
  #update
    tracks an analytics event
    the user has not been sent an otp
      redirects to otp delivery method selection
    track irs analytics event
      when the phone otp code is valid
        captures success event
      when the phone otp code is invalid
        captures failure event
    the user has already confirmed their phone
      redirects to the review step
  before_actions
    includes before_actions from IdvSession

Users::EmailLanguageController
  #update
    with an invalid language selection
      logs an unsuccessful analytics event
      redirects to the account page, no success flash
      does not change the user email_language
    with a valid language selection
      redirects to the account page with a success flash
      updates the user email_language
      logs a successful analytics event
  before_actions
    includes appropriate before_actions
  #show
    renders
    logs an analytics event for visiting

Idv::DocAuthController
  async document verify status
    returns status of fail
    returns status of fail with incomplete PII from doc auth
    returns status of success
    returns status of hard fail
    returns status of in progress
  unauthenticated
    redirects to the root url
  before_actions
    includes corrects before_actions
    includes before_actions from IdvSession
  #show
    renders the correct template
    renders a 404 with a non existent step
    increments the analytics step counts on subsequent submissions
    tracks analytics
    redirects to the right step
    tracks analytics for the optional step
    with an existing applicant
      finishes the flow
  #index
    redirects to the first step
    with pending in person enrollment
      redirects to in person ready to verify page
  #update
    tracks analytics
    redirects from welcome to no camera error
    increments the analytics step counts on subsequent submissions
    with an existing applicant
      finishes the flow

Api::Verify::DocumentCaptureErrorsController
  extends behavior of base api class
  #delete
    renders as unauthorized (401)
    with signed in user
      behaves like deleting document capture errors
        renders errors for missing fields
        with valid document capture session
          deletes errors and renders successful response
        with invalid document capture session
          renders errors for invalid document capture session
    with hybrid effective user
      behaves like deleting document capture errors
        renders errors for missing fields
        with invalid document capture session
          renders errors for invalid document capture session
        with valid document capture session
          deletes errors and renders successful response

AccountReset::RecoveryOptionsController
  #cancel
    logs the visit to analytics
    redirects to 2FA options page
  #show
    redirects to root if user not signed in
    renders the page
    logs the visit to analytics

Idv::ReviewController
  #confirm_current_password
    user provides wrong password
      redirects to new
      tracks irs password entered event (idv_password_entered)
    user provides correct password
      allows request to proceed
    user does not provide password
      redirects to new
  #confirm_idv_steps_complete
    user has missed address step
      redirects to address step
  #confirm_idv_phone_confirmed
    user phone is confirmed
      does not redirect
    user phone is not confirmed
      redirects to phone confirmation
    user is verifying by mail
      does not redirect
  #new
    user has not requested too much mail
      displays a success message
    user has completed all steps
      displays a helpful flash message to the user
      shows completed session
    user has requested too much mail
      displays a helpful error message
  #create
    user has completed all steps
      redirects to personal key path
      creates Profile with applicant attributes
      redirects to confirmation path after user presses the back button
      tracks irs password entered event (idv_password_entered)
      user picked GPO confirmation
        leaves profile deactivated
      user picked phone confirmation
        creates an `account_verified` event once per confirmation
        activates profile
        dispatches account verified alert
        with in person profile
          creates a USPS enrollment
          redirects to personal key path
          does not dispatch account verified alert
          creates an in-person enrollment record
          sends ready to verify email
          when user enters an address2 value
            provides address2 if the user entered it
          when the USPS response is missing an enrollment code
            logs an error message
            leaves the enrollment in establishing
          when there is 5xx error
            allows the user to retry the request
            leaves the enrollment in establishing
            logs the error message
          when there is a 4xx error
            logs the response message
            leaves the enrollment in establishing
        when the user goes through reproofing
          does not log a reproofing event during initial proofing
          logs a reproofing event upon reproofing
        with threatmetrix required but review status did not pass
          creates a disabled profile
    user fails to supply correct password
      redirects to original path
  before_actions
    includes before_actions from IdvSession
    includes before_actions from AccountStateChecker

Idv::PhoneErrorsController
  #jobfail
    with throttle attempts
      logs an event
      assigns remaining count
    behaves like an idv phone errors controller action
      the user is authenticated and has confirmed their phone
        redirects to the review url
      the user is not authenticated and not recovering their account
        redirects to sign in
      before_actions
        includes before_actions from IdvSession
      the user is authenticated and has not confirmed their phone
        renders the error
  #failure
    behaves like an idv phone errors controller action
      the user is authenticated and has not confirmed their phone
        renders the error
      the user is authenticated and has confirmed their phone
        redirects to the review url
      before_actions
        includes before_actions from IdvSession
      the user is not authenticated and not recovering their account
        redirects to sign in
    while throttled
      logs an event
      assigns expiration time
  #timeout
    with throttle attempts
      assigns remaining count
    behaves like an idv phone errors controller action
      the user is authenticated and has confirmed their phone
        redirects to the review url
      the user is authenticated and has not confirmed their phone
        renders the error
      the user is not authenticated and not recovering their account
        redirects to sign in
      before_actions
        includes before_actions from IdvSession
  #warning
    behaves like an idv phone errors controller action
      the user is authenticated and has confirmed their phone
        redirects to the review url
      the user is not authenticated and not recovering their account
        redirects to sign in
      before_actions
        includes before_actions from IdvSession
      the user is authenticated and has not confirmed their phone
        renders the error
    with throttle attempts
      logs an event
      assigns remaining count

Idv::InPersonController
  #index
    renders 404 not found
    with in person proofing enabled
      redirects to the root url
      signed in
        redirects to idv
        with establishing in-person enrollment
          redirects to the first step
          with an existing applicant
            finishes the flow
          with associated service provider
            renders 404 not found
            with in person proofing enabled for service provider
              redirects to the first step
  before_actions
    includes corrects before_actions

PasswordCaptureController
  #update
    form returns success
      decrypts PII and redirects
    form errors
      increases password attempts

TwoFactorAuthentication::TotpVerificationController
  #show
    when the user does not have an authenticator app enabled
      redirects to user_two_factor_authentication_path
    when the user has an authenticator app enabled
      logs the visited event
      sets view assigns
      when FeatureManagement.prefill_otp_codes? is true
        sets view assigns
  #create
    when the user enters a valid TOTP
      resets the second_factor_attempts_count
      redirects to the profile
      tracks the valid authentication event
    when the user lockout period expires
      when user submits a valid TOTP
        resets second_factor_locked_at
        resets attempts count
      when user submits an invalid form
        fails with no code parameter
        fails with empty code
      when user submits an invalid TOTP
        resets attempts count
        resets second_factor_locked_at
    when the user does not have an authenticator app enabled
      redirects to user_two_factor_authentication_path
    when the user has reached the max number of TOTP attempts
      tracks the event
    when the user enters an invalid TOTP
      displays flash error message
      re-renders the TOTP entry screen
      increments second_factor_attempts_count

Idv::ImageUploadsController
  #create
    when document capture session is invalid
      returns error status when document_capture_session is not provided
      returns error status when document_capture_session is invalid
    when image upload succeeds
      tracks events
      returns a successful response and modifies the session
      but doc_pii validation fails
        but doc_pii validation fails due to invalid DOB
          tracks dob validation errors in analytics
        due to invalid Name
          tracks name validation errors in analytics
        due to invalid State
          tracks state validation errors in analytics
        encrypted document storage is enabled
          includes image references in attempts api
      encrypted document storage is enabled
        includes image fields in attempts api event
    when required pii field is missing from doc response
      returns error
    when image upload fails
      returns an error response
      tracks events
    throttling
      tracks events
      returns remaining_attempts with error
      returns an error when throttled
    when fields are missing
      returns error status when not provided image fields
      tracks events
    when a value is an error-formatted yaml file
      tracks events
      returns error from yaml file
    when a value is not a file
      tracks events
      returns an error
      with a locale param
        translates errors using the locale param

Users::AuthorizationConfirmationController
  #create
    redirects to the sp request url
  #new
    renders for a signed in user
    redirects for a user without an SP
  #destroy
    signs out the user and redircts to sign in with the request id

Idv::PhoneController
  #create
    when form is invalid
      disallows non-US numbers
      tracks form error events and does not make a vendor API call
      renders #new
    when form is valid
      tracks event with valid phone
      tracks events with valid phone
      when same as user phone
        redirects to otp delivery page
        with full vendor outage
          redirects to vendor outage page
      when different phone from user phone
        redirects to otp page and does not set phone_confirmed_at
        with full vendor outage
          redirects to vendor outage page
    when verification fails
      tracks event with invalid phone
      renders failure page and does not set phone confirmation
      when the user is throttled by submission
        tracks throttled event
  before_actions
    includes authentication before_action
  before_actions
    includes before_actions from IdvSession
  #new
    shows phone form if async process times out and allows successful resubmission
    shows waiting interstitial if async process is in progress
    when the phone number has been confirmed as user 2FA phone
      redirects to review when step is complete
    when the phone number has not been confirmed as user 2FA phone
      renders the form
    when the user has chosen to use a different number
      logs an event showing that the user wants to choose a different number
    when the user is throttled
      redirects to fail

NoJsController
  #index
    assigns session key
    returns empty css

ServiceProviderController
  #update
    feature on, correct token in headers
      returns 200
      updates the matching ServiceProvider in the DB
      with CSRF protection enabled
        ignores invalid CSRF tokens
    incorrect token in header
      returns a 401

Users::ServiceProviderRevokeController
  #destroy
    logs an analytics event for revoking
    marks the identity as deleted and redirects
    when the sp_id is not valid
      does not error, just redirects to the account page
    when the sp_id links to a valid SP but it has not been linked
      does not error, just redirects to the account page
  #show
    renders
    logs an analytics event for visiting
    when the sp_id is not valid
      does not error, just redirects to the account page
    when the sp_id links to a valid SP but it has not been linked
      does not error, just redirects to the account page
  before_actions
    includes appropriate before_actions

Health::HealthController
  #index
    when all checked resources are healthy
      returns a successful JSON response
    all resources are unhealthy
      returns an unsuccessful JSON response
    when one resource is unhealthy
      returns an unsuccessful JSON response

Api::IrsAttemptsApiController
  #create
    returns an error with empty timestamp parameter
    returns an error with invalid timestamp parameter
    authenticates the client
    renders a 404 if disabled
    renders encrypted events
    returns an error without required timestamp parameter
    with CSRF protection enabled
      allows authentication without error
    with a timestamp including a fractional second
      accepts the timestamp as valid

Idv::SessionsController
  #destroy
    tracks the event in analytics
    redirect occurs to the start of identity verification
    when destroying the session
      clears the idv/doc_auth session
      clears the decrypted_pii session
      clears the idv/in_person session
      clears the idv/inherited_proofing session
    pending profile
      cancels verification attempt
    with in person enrollment
      cancels pending in person enrollment
      cancels establishing in person enrollment

OpenidConnect::TokenController
  #create
    with invalid params
      tracks an unsuccessful event in analytics
      is a 400 and has an error response and no id_token
    with valid params
      is successful and has a response with the id_token
      tracks a successful event in analytics
    with invalid form
      is a 400 and has an error response and no id_token

Idv::ResendOtpController
  before_actions
    includes before_actions from IdvSession
  #create
    tracks an analytics event
    Telephony raises an exception
      tracks an analytics events
    the user has already confirmed their phone
      redirects to the review step
    the user has not selected a delivery method
      redirects to otp delivery method selection

Users::TwoFactorAuthenticationController
  before_actions
    includes the appropriate before_actions
  #send_code
    phone is not confirmed
      flashes an sms error when the telephony gem responds with an sms error
      rate limits confirmation OTPs when adding number to existing account
      sends OTP inline when confirming phone
      tracks the enrollment attempt event
      rate limits confirmation OTPs on sign up
      marks the user as locked out after too many attempts on sign up
    when selecting voice OTP delivery
      redirects to two factor options path with invalid id
      sends OTP via voice
      tracks the event
    when selecting SMS OTP delivery
      tracks the attempt event when user session context is reauthentication
      tracks the verification attempt event
      tracks the analytics events
      sends OTP via SMS for sign in
      calls OtpRateLimiter#exceeded_otp_send_limit? and #increment
      marks the user as locked out after too many attempts
      when the phone has been marked as opted out in the DB
        does not send an OTP
      when Pinpoint throws an opt-out error
        redirects to the opt in controller
    when selecting an invalid delivery method
      redirects user to choose a valid delivery method
  #show
    when the user has not already set up 2FA
      redirects to set up 2FA
    when the user has already set up 2FA
      sends OTP via otp_delivery_preference and prompts for OTP
      when no options are enabled and available for use
        redirects to mfa options page
    when user is authenticated with a remembered device via phone
      does redirect to the profile
      does redirect to sms if reauthn parameter is true
    when user is piv/cac enabled
      renders the piv/cac entry screen
    when user has backup codes
      passes reauthn parameter on redirect
      renders the :backup_code view
    when user is TOTP enabled
      renders the :confirm_totp view
      passes reauthn parameter on redirect
    when phone is sole configured mfa and full phone vendor outage
      redirects to vendor outage page
    when there is no session (signed out or locked out), and the user reloads the page
      redirects to the home page
    when SP requires PIV/CAC
      redirects to MFA setup if no PIV/CAC is enabled
    when user is webauthn enabled
      passes the platform parameter if the user has a platform autheticator
      renders the :webauthn view
      passes reauthn parameter on redirect
  #check_already_authenticated
    when the user is fully authenticated and the context is not authentication
      does not redirect to the profile
    when the user is fully authenticated and the context is authentication
      redirects to the profile
    when the user is not fully signed in
      does not redirect to the profile

Idv::CaptureDocStatusController
  #show
    when flow session expires
      returns unauthorized
    when capture failed
      returns unauthorized
    when the user cancelled document capture on their phone
      returns cancelled
    when unauthenticated
      redirects to the root url
    when capture succeeded
      returns success
    when result is pending
      returns pending result
    when user opted for in-person proofing
      returns success with redirect
    when capture succeeded with barcode attention
      when result is confirmed
        assigns flow session values as having received attention result
        returns success
      when barcode attention result is pending confirmation
        returns pending result
        assigns flow session values as having received attention result
      when user receives a second result that is not the attention result
        assigns flow session values as not having received attention result
      when loaded result expires but session was already marked with attention result
        when result is confirmed
          returns success
          assigns flow session values as having received attention result
        when barcode attention result is pending confirmation
          returns pending result
          assigns flow session values as having received attention result
    when session does not exist
      returns unauthorized
    when the user is throttled
      returns throttled with redirect

Users::PhonesController
  user adds phone
    gives the user a form to enter a new phone number
  user exceeds phone number limit
    renders the #phone anchor when it exceeds limit
    it redirects to two factor auth url if the referer was two factor auth
    displays error if phone number exceeds limit
    defaults to account url if the url is anything but two factor auth url
  phone vendor outage
    redirects to outage page

Test::PushNotificationController
  #destroy
    clears events and redirects to index
  #index
    sets @events and renders
    404s in production

Users::MfaSelectionController
  #update
    submits the TwoFactorOptionsForm
    when the selection is not valid
      renders the index page
    when multi selection with auth app first
      redirects properly
    when the selection is auth_app
      redirects to authentication app setup page
    when the form is empty
      with an active MFA
        redirects to after_mfa_setup_path
      with no active MFA
        redirects to the index page with a flash error
    when the selection is webauthn platform authenticator
      redirects to webauthn setup page with the platform param
    when the selection is piv_cac
      redirects to piv/cac setup page
    when the selection is webauthn
      redirects to webauthn setup page
    when multi selection with phone first
      redirects properly
    when the selection is only phone and multi mfa is enabled
      the redirect to the form page with an anchor
      contains a flash message
    when the selection is phone
      redirects to phone setup page
  #index
    when the user is using one authenticator option
      shows the mfa setup screen

Test::PivCacAuthenticationTestSubjectController
  when not in development
    routes
      has a route to GET new
    POST create
      redirects to root_url
    GET new
      redirects to root_url
    FeatureManagement#development_and_identity_pki_disabled?
      is disabled
  when in development
    FeatureManagement#development_and_identity_pki_disabled?
      is enabled
    POST create
      returns a redirect
    GET new
      renders a page

ReactivateAccountController
  #index
    wthout a password reset profile
      redirects to the root url
    with a password reset profile
      renders the index template
  #update
    redirects user to idv_url
  before_actions
    requires the user to be logged in

Test::FakeS3Controller
  #update
    stores the data in memory
  #show
    with a valid key
      is that data
    with an unknown key
      404s

Idv::InPerson::UspsLocationsController
  #index
    with arcgis search disabled
      with successful fetch
        returns a successful response
    with arcgis search enabled
      with unsuccessful fetch
        gets an empty response
      with a nil address in params
        returns the pilot locations
      with successful fetch
        returns a successful response
    with in person proofing disabled
      renders 404
  #update
    writes the passed location to in-person enrollment
    with associated service provider
      assigns services provider to in-person enrollment
    with hybrid user
      writes the passed location to in-person enrollment associated with effective user
    with feature disabled
      renders 404
    when unauthenticated
      renders an unauthorized status

Idv::InheritedProofingCancellationsController
  #destroy
    when there is no session
      redirects to root
    when there is a session
      tracks the event in analytics
      destroys session
      renders a json response with the redirect path set to account_path
  #update
    tracks the event in analytics
    redirects to idv_inherited_proofing_path
    when a go back path is stored in session
      redirects to go back path
  #new
    when the flow step is not in the allowed list
      #update
        behaves like an HTML 404 not found
          returns a 404 not found
      #destroy
        behaves like an HTML 404 not found
          returns a 404 not found
      #new
        behaves like an HTML 404 not found
          returns a 404 not found
    when there is a session
      tracks the event in analytics
      renders template
      stores go back path
    when there is no session
      redirects to root
    when the inherited proofing feature flipper is turned off
      #new
        behaves like an HTML 404 not found
          returns a 404 not found
      #update
        behaves like an HTML 404 not found
          returns a 404 not found
      #destroy
        behaves like an HTML 404 not found
          returns a 404 not found
  before_actions
    includes before_actions from AllowlistedFlowStepConcern
    includes before_actions from IdvSession
    includes before_actions from InheritedProofing404Concern

Idv::GpoVerifyController
  #create
    with a valid form
      dispatches account verified alert
      redirects to the sign_up/completions page
      with establishing in person enrollment
        does not dispatch account verified alert
        redirects to ready to verify screen
    with throttle reached
      renders the index page to show errors
    with an invalid form
      redirects to the index page to show errors
      does not 500 with missing form keys
  #index
    with throttle reached
      renders throttled page
    user has pending profile
      shows throttled page is user is throttled
      renders page
    user does not have pending profile
      redirects to account page

ReauthnRequiredController
  #confirm_recently_authenticated
    authenticated outside the authn window
      sets context to authentication
      redirects to password confirmation
    recently authenticated
      allows action

Idv::InPerson::ReadyToVerifyController
  before_actions
    includes authentication before_action
  #show
    renders not found
    with in person proofing enabled
      redirects to account page
      with enrollment
        renders show template
        logs analytics

SignUp::RegistrationsController
  #new
    gracefully handles invalid formats
    cannot be viewed by signed in users
    allows user to visit the sign up page
  #create
    renders new if request_id is blank
    renders new if email is a Hash
    tracks successful user registration with existing email
    tracks unsuccessful user registration
    renders new if email is nil
    when registering with a new email
      tracks successful user registration
      sets the email in the session and redirects to sign_up_verify_email_path
      sets the users preferred email locale and sends an email in that locale
      cannot be accessed by signed in users

Users::ForgetAllBrowsersController
  #destroy
    updates the remember_device_revoked_at attribute for the user
    logs an analytics event for forgetting
    redirects to the account page
  #show
    renders
    does not change remember_device_revoked_at
    logs an analytics event for visiting
  before_actions
    includes appropriate before_actions

OpenidConnect::UserInfoController
  #show
    with a malformed authorization header
      401s
      tracks analytics
    with a valid bearer token
      renders user info
      only changes the paths visited in session
      tracks analytics
    without an authorization header
      tracks analytics
      401s
    with an invalid bearer token
      tracks analytics
      401s

InheritedProofingConcern
  #inherited_proofing_service_provider
    when a service provider can be identified
      returns the service provider
    when a service provider cannot be identified
      returns nil
  #va_inherited_proofing?
    when the va auth code is present
      returns true
    when the va auth code is not present
      returns false
  #va_inherited_proofing_auth_code_params_key
    returns the correct va auth code url query param key
  #inherited_proofing?
    when inherited proofing proofing is not effect
      returns false
    when inherited proofing proofing is effect
      returns true
  #inherited_proofing_service_provider_data
    when the inherited proofing request cannot be identified
      returns an empty hash
    when there is a va inherited proofing request
      returns the correct service provider-specific data

TwoFactorAuthentication::OptionsController
  #create
    redirects to login_two_factor_url if user selects sms
    tracks analytics event
    redirects to login_two_factor_url if user selects voice
    redirects to login_two_factor_webauthn_url with param if user selects platform auth
    rerenders the page with errors on failure
    redirects to login_two_factor_webauthn_url if user selects webauthn
    redirects to login_two_factor_authenticator_url if user selects auth_app
    sets phone_id in session when selecting a phone option
    redirects to login_two_factor_piv_cac_url if user selects piv_cac
  #index
    logs an analytics event
    renders the page

OpenidConnect::ConfigurationController
  #index
    sets HTTP headers to cache for a week
    renders information about the OpenID Connect integration

Api::Verify::DocumentCaptureController
  extends behavior of base api class
  #create
    renders as bad request (400)
    When user document is submitted to be verified
      returns inprogress status when create is called
      When the request does not have all the parameters
        returns 400 and gives error message
    signed out
      renders as unauthorized (401)
      with hybrid effective user
        renders as bad request (400)

Users::VerifyPasswordController
  without password_reset_profile
    #new
      redirects user to the home page
  with password reset profile
    with personal key flag set
      #update
        without valid password
          renders the new template
        with valid password
          redirects to the account page
          sets a new personal key as a flash message
      #new
        renders the `new` template
    without personal key flag set
      #new
        redirects to the root url
      #update
        redirects to the root url

Idv::StepIndicatorConcern
  #step_indicator_steps
    returns doc auth steps
    with in person proofing component
      with proofing component via pending profile
        returns in person gpo steps
      with proofing component via current idv session
        returns in person steps
        with gpo address verification method
          returns in person gpo steps
    with gpo address verification method
      returns doc auth gpo steps
    with pending profile
      returns doc auth gpo steps

Users::WebauthnSetupController
  when not signed in
    patch confirm
      redirects to root url
    GET new
      redirects to root url
  when signed in and account creation
    Multiple MFA options turned off
      with a single MFA method chosen
        should direct user to second mfa suggestion page
    Multiple MFA options turned on
      with only webauthn_platform chosen on account creation
        should log expected events
      with multiple MFA methods chosen on account creation
        should log expected events
      with a single MFA method chosen on account creation
        should direct user to second mfa suggestion page
      with attestation response error
        should log expected events
      with multiple MFA methods chosen on account creation
        should direct user to next method confirmation page
  when signed in and not account creation
    patch confirm
      tracks the submission
    GET new
      tracks page visit
    show_delete
      redirects when the configuration does not exist
      renders page when configuration exists
    delete
      tracks the delete in analytics
      creates a webauthn key removed event
      sends a recovery information changed event
  before_actions
    includes appropriate before_actions

Redirect::ReturnToSpController
  #failure_to_proof
    when there is an SP in the session
      redirects to the SP
    with step or location parameters
      logs with extra analytics properties
    when there is no SP
      redirects to the account
  #cancel
    when there is no SP
      redirects to the account
    when there is a SP request url for the request id param
      redirects to the redirect URI in the request url
    when there is an SP request in the session
      redirects to the redirect URI in the request url
    when there is an SP in the session without a request url
      redirects to the configured request url

Users::TotpSetupController
  #new
    user is setting up authenticator app during account creation
      captures an analytics event
      can be used to generate a qrcode with UserDecorator#qrcode
      returns a 200 status code
      sets new_totp_secret in user_session
    user is setting up authenticator app after account creation
      sets new_totp_secret in user_session
      captures an analytics event
      can be used to generate a qrcode with UserDecorator#qrcode
      returns a 200 status code
  #disable
    when a user has configured TOTP
      disables TOTP
    when totp is the last mfa method
      does not disable totp
  #confirm
    user is not yet signed up
      when totp secret is no longer in user_session
        redirects with an error message
      when user presents correct code
        when user has multiple MFA methods left in user session
          redirects to next mfa path with a success message and still logs analytics
        when user selected only one method on account creation
          redirects to auth method confirmation path with a success message
      when user presents invalid code
        redirects with an error message
    user is already signed up
      when user presents invalid code
        redirects with an error message
      when user omits name
        redirects with an error message
      when user presents nil code
        redirects with an error message
      when user presents correct code
        redirects to account_path with a success message
  before_actions
    includes appropriate before_actions

AnalyticsEventsController
  #index
    when the JSON file exists
      renders the file
    when the JSON file does not exist
      404s

Idv::ForgotPasswordController
  #update
    tracks appropriate events
  #new
    tracks the event in analytics when referer is nil
  before_actions
    includes before_actions from IdvSession

OpenidConnect::AuthorizationController
  #index
    user is not signed in
      sets sp information in the session and does not transmit ial2 attrs for ial1
      redirects to SP landing page with the request_id in the params
      with a bad redirect_uri
        renders the error page
      with an inherited_proofing_auth code
        redirects to SP landing page with the request_id in the params
        persists the inherited_proofing_auth value
      without valid acr_values
        handles the error and does not blow up
    user is signed in
      with invalid params that mean the redirect_uri is not trusted
        renders the error page
        tracks the event with errors
      with invalid params that do not interfere with the redirect_uri
        tracks the event with errors
        redirects to the redirect_uri immediately with an invalid_request
      with valid params
        redirects back to the client app with a code
        tracks IAL1 authentication event
        with ial2 requested
          account is already verified
            redirects to the redirect_uri immediately when pii is unlocked
            redirects to the password capture url when pii is locked
            tracks IAL2 authentication event
          profile is reset
            redirects to have the user enter their personal key
          account is not already verified
            redirects to have the user verify their account
        user has not approved this application
          redirects verify shared attributes page
          does not link identity to the user
        user has already approved this application
          redirects back to the client app with a code
        with ialmax requested
          account is already verified
            redirects to the password capture url when pii is locked
            redirects to the redirect_uri immediately when pii is unlocked
            tracks IAL2 authentication event
          profile is reset
            tracks IAL1 authentication event
            redirects to the redirect_uri immediately without proofing
          account is not already verified
            tracks IAL1 authentication event
            redirects to the redirect_uri immediately without proofing

SignUp::EmailsController
  #show
    email in session
      renders the page and deletes the email from the session
    no email in session
      redirects to the new user registration path

Users::EmailsController
  #resend
    valid email exists in session
      sends email
    no valid email exists in session
      shows an error and redirects to add email page
  #verify
    with malformed payload
      does not blow up
  #limit
    user exceeds email limit
      displays error if email exceeds limit

SignUp::PasswordsController
  #new
    instructs crawlers to not index this page
    rejects when confirmation_token is invalid
  #create
    tracks a valid password event
    tracks an invalid password event
    rejects when confirmation_token is invalid

Health::DatabaseController
  #index
    when the database is unhealthy
      is a 500
      renders the error
    when the database is healthy
      renders the result
      is a 200

Users::BackupCodeSetupController
  creates backup codes and logs expected events
  deletes backup codes
  does not deletes backup codes if they are the only mfa
  #refreshed
    does not 500 when codes have not been generated
  with multiple MFA selection on
    when user selects multiple mfas on account creation
      redirects to Phone Url Page after page
    when user only selects backup code on account creation
      redirects to Suggest 2nd MFA page
  with multiple MFA selection turned off
    redirects to account page

OpenidConnect::LogoutController
  when rejecting id_token_hint
    #delete
      when sending id_token_hint
        user is signed in
          destroys the session
        user is not signed in
          destroys the session
      when sending client_id
        user is signed in
          tracks events
          destroys the session
        user is not signed in
          destroys the session
    #index
      user is signed in
        with valid params
          tracks events
          renders logout confirmation page
        with a bad redirect URI
          renders an error page
          tracks events
          does not destroy the session
        with an id_token_hint
          does not destroy the session
          tracks events
          renders an error page
      user is not signed in
        redirects back to client
  when accepting id_token_hint and client_id
    #delete
      when sending id_token_hint
        user is signed in
          destroys the session
        user is not signed in
          destroys the session
      when sending client_id
        user is not signed in
          destroys the session
        user is signed in
          destroys the session
    #index
      when sending id_token_hint
        user is not signed in
          redirects back with an error
        user is signed in
          with valid params
            destroys the session
            redirects back to the client
            tracks events
          with a bad redirect URI
            renders an error page
            tracks events
            does not destroy the session
          with a bad id_token_hint
            tracks events
      when sending client_id
        user is signed in
          with a bad redirect URI
            tracks events
            renders an error page
            does not destroy the session
          with valid params
            renders logout confirmation page
        user is not signed in
          redirects back to client

Idv::InPerson::AddressSearchController
  #index
    with unsuccessful fetch
      gets an empty pilot response
    with feature disabled
      renders 404
    with successful fetch
      gets successful response
      with no suggestions
        returns empty array

CountrySupportController
  #index
    sets HTTP headers to cache for 15 minutes
    renders country support as JSON
    renders when passing in different locale
      renders country support with localization support

SignUp::EmailConfirmationsController
  #create
    tracks blank email confirmation token
    tracks confirmation token as a single-quoted empty string
    tracks expired token
    tracks confirmation token as a double-quoted empty string
    tracks already confirmed token
    tracks nil email confirmation token
    tracks blank confirmation_sent_at as expired token
  Two users simultaneously confirm email with race condition
    does not throw a 500 error
  Valid email confirmation tokens
    tracks a valid email confirmation token event

AccountsController
  before_actions
    includes before_actions from AccountStateChecker
  #show
    when user has an active identity
      renders the profile and does not redirect out of the app
    when logging in with piv/cac
      when the user is proofed
        renders a locked profile
    when a profile is pending
      renders the pending profile banner
    when a profile has been deactivated by password reset
      renders the profile and shows a deactivation banner

Users::PhoneSetupController
  GET index
    when signed out
      redirects to sign in page
    when signed in
      renders the index view
  before_actions
    includes the appropriate before_actions
  PATCH create
    tracks an event when the number is invalid
    with SMS
      prompts to confirm the number
    with voice
      prompts to confirm the number
    without selection
      prompts to confirm via SMS by default

Users::TwoFactorAuthenticationSetupController
  GET index
    tracks the visit in analytics
    when fully authenticated and MFA enabled
      loads the account page
    already two factor enabled but not fully authenticated
      prompts for 2FA
    when fully authenticated but not MFA enabled
      allows access
    when signed out
      redirects to sign in page
  PATCH create
    submits the TwoFactorOptionsForm
    tracks IRS attempts event
    tracks analytics event
    when the selection is auth_app
      redirects to authentication app setup page
    when the selection is webauthn
      redirects to webauthn setup page
    when multi selection with phone first
      redirects properly
    when the selection is webauthn platform authenticator
      redirects to webauthn setup page with the platform param
    when multi selection with auth app first
      redirects properly
    when the selection is not valid
      renders index page
    when the selection is only phone and multi mfa is enabled
      the redirect to the form page with an anchor
      contains a flash message
    when the selection is piv_cac
      redirects to piv/cac setup page

TwoFactorAuthentication::WebauthnVerificationController
  when not signed in
    patch confirm
      redirects to root url
    GET show
      redirects to root url
  when signed in before 2fa
    GET show
      redirects if no webauthn configured
      with webauthn configured
        tracks an analytics event
    patch confirm
      tracks an invalid submission
      tracks a valid non-platform authenticator submission
      tracks a valid platform authenticator submission
      webauthn_platform returns an error from frontend API
        User only has webauthn as an MFA method
          redirects to webauthn error page
        User has multiple MFA options
          displays flash error message
          redirects to webauthn show page

EffectiveUser
  #effective_user
    logged out
      returns nil
    non-existent user
      returns session user id
    logged in
      returns session user id
    logged out with doc capture session user id
      returns session user id

Idv::SessionErrorsController
  before_actions
    includes before_actions from IdvSession
  #failure
    while throttled
      assigns expiration time
    behaves like an idv session errors controller action
      the user is authenticated and has confirmed their profile
        redirects to the phone url
      the user is not authenticated and in doc capture flow
        renders the error
      the user is authenticated and has not confirmed their profile
        renders the error
      the user is not authenticated and not recovering their account
        redirects to sign in
  #throttled
    behaves like an idv session errors controller action
      the user is authenticated and has confirmed their profile
        redirects to the phone url
      the user is not authenticated and not recovering their account
        redirects to sign in
      the user is not authenticated and in doc capture flow
        renders the error
      the user is authenticated and has not confirmed their profile
        renders the error
    while throttled
      assigns expiration time
  #exception
    behaves like an idv session errors controller action
      the user is not authenticated and in doc capture flow
        renders the error
      the user is authenticated and has not confirmed their profile
        renders the error
      the user is not authenticated and not recovering their account
        redirects to sign in
      the user is authenticated and has confirmed their profile
        redirects to the phone url
  #ssn_failure
    behaves like an idv session errors controller action
      the user is not authenticated and not recovering their account
        redirects to sign in
      the user is authenticated and has confirmed their profile
        redirects to the phone url
      the user is authenticated and has not confirmed their profile
        renders the error
      the user is not authenticated and in doc capture flow
        renders the error
    while throttled
      assigns expiration time
  #warning
    behaves like an idv session errors controller action
      the user is authenticated and has confirmed their profile
        redirects to the phone url
      the user is authenticated and has not confirmed their profile
        renders the error
      the user is not authenticated and in doc capture flow
        renders the error
      the user is not authenticated and not recovering their account
        redirects to sign in
    with throttle attempts
      assigns remaining count
      assigns URL to try again
      in in-person proofing flow
        assigns URL to try again

TwoFactorAuthentication::OtpVerificationController
  #show
    tracks the page visit and context
    redirects to phone setup page if user does not have a phone yet
    when there is no session (signed out or locked out), and the user reloads the page
      redirects to the home page
    when resource is not fully authenticated yet
      when FeatureManagement.prefill_otp_codes? is false
        does not set @code_value
      when FeatureManagement.prefill_otp_codes? is true
        sets code_value on presenter to correct OTP value
      when the user has an invalid phone number in the session
        redirects to homepage
  #create
    when the user enters a valid OTP
      tracks the attempt event with reauthentication parameter true
      redirects to the profile
      resets the second_factor_attempts_count
      tracks the valid authentication event
      without remember_device in the params
        does not save an encrypted cookie
      with remember_device in the params
        saves an encrypted cookie
    when the user enters an invalid OTP during authentication context
      displays flash error message
      redirects to the OTP entry screen
      increments second_factor_attempts_count
    when the user has reached the max number of OTP attempts
      tracks the event
    when the user enters an invalid OTP during reauthentication context
      increments second_factor_attempts_count
    when the user lockout period expires
      when user submits an invalid OTP
        resets attempts count
        resets second_factor_locked_at
      when user submits a valid OTP
        resets second_factor_locked_at
        resets attempts count
    phone confirmation
      with remember_device in the params
        saves an encrypted cookie
      when user does not have an existing phone number
        when given valid code
          resets context to authentication
          redirects to profile page
          tracks the confirmation event
        Feature flag #select_multiple_mfa_options is true
          one MFA option selected
            redirects to auth_confirmation page
          multiple MFA options selected
            redirects to next mfa method with backup code next
      user has an existing phone number
        user enters an invalid code
          tracks an event
          displays error flash notice
          does not update user phone or phone_confirmed_at attributes
          increments second_factor_attempts_count
          renders :show
          does not clear session data
          user has exceeded the maximum number of attempts
            tracks the attempt event
        user enters a valid code
          resets otp session data
          tracks the update event and notifies via email about number change
        user does not include a code parameter
          fails and increments attempts count
      without remember_device in the params
        does not save an encrypted cookie

Idv::ThreatMetrixConcern
  #override_csp_for_threat_metrix
    ff is not set
      does not modify CSP headers for any other step
      does not modify CSP headers for SSN step
    ff is set
      modifies CSP headers for SSN step
      does not modify CSP headers for any other step

Test::TelephonyController
  #index
    sets @messages and @calls and renders
    404s in production
  #destroy
    clears messages and calls and redirects to index

Users::PasswordsController
  #edit
    user has a profile with PII
      redirects to capture password if PII is not decrypted
      renders form if PII is decrypted
  #update
    form returns success
      sends a security event
      calls UpdateUserPassword
      redirects to profile and sends a password change email
      creates a user Event for the password change
      sends the user an email
    form returns failure
      does not create a password_changed user Event
      renders edit

Idv::GpoController
  #create
    resending a letter
      calls GpoConfirmationMaker to send another letter with reveal_gpo_code on
      redirects to capture password if pii is locked
      logs attempts api tracking
      calls the GpoConfirmationMaker to send another letter and redirects
    first time through the idv process
      sets session to :gpo and redirects
      logs attempts api tracking
  before_actions
    includes authentication before_action
    includes before_actions from IdvSession
  #index
    assigns the current step indicator step as "verify phone or address"
    redirects if the user has sent too much mail
    renders confirmation page
    allows a user to request another letter
    resending a letter
      assigns the current step indicator step as "get a letter"
    with letter already sent
      logs visited event

Idv::PhoneOtpRateLimitable
  #handle_too_many_otp_sends
    calls irs tracking event idv_phone_otp_sent_rate_limited
    calls analytics tracking event

AccountReset::PendingController
  #show
    when the account reset request does not exist
      renders a 404
  #cancel
    cancels the account reset request and logs the cancellation event
    when the account reset request does not exist
      renders a 404

Accounts::PersonalKeysController
  before_actions
    require recent reauthn
  #create
    tracks CSRF errors
    generates a new personal key, tracks an analytics event, and redirects
    prompts for password if PII is not present
  #new
    tracks an event for viewing profile personal key

Users::PersonalKeysController
  #show
    tracks the page visit when there is no personal key in the user session
    does not generate a new personal key to avoid CSRF attacks
    tracks the page visit when there is a personal key in the user session
    when there is no session (signed out or locked out), and the user reloads the page
      redirects to the home page
    when user signed in but user_session[:personal_key] is not present
      redirects to account_url
  #update
    deletes user_session[:personal_key]
    tracks CSRF errors
    user does not need to reactivate account
      redirects to the profile page
    user needs to reactive account
      redirects to the sign up completed url for ial 1
      redirects to the reactivate account url for ial 2

Idv::OtpDeliveryMethodController
  #create
    the telephony gem raises an exception
      tracks an analytics events
    form is invalid
      tracks appropriate events
      renders the new template
    user has not selected phone verification method
      redirects to the review controller
    user has not completed phone step
      redirects to the phone controller
    user has selected voice
      tracks appropriate events
      redirects to the otp send path for voice
    user has selected sms
      redirects to the otp send path for sms
      tracks appropriate events
    user has confirmed phone number
      redirects to the review controller
  before_actions
    includes before_actions from IdvSession
  #new
    tracks an analytics event
    user has selected phone verification and not confirmed phone
      renders
    user has not selected phone verification method
      redirects to the review controller
    user has not completed phone step
      redirects to the phone controller
    user has confirmed phone number
      redirects to the review controller

Idv::SetupErrorsController
  renders the show template

Idv::DocumentCaptureConcern
  #override_document_capture_step_csp
    does not set headers for any other step
    sets the headers for the document capture step

Redirect::ContactController
  #show
    redirects to contact page

SamlIdpController
  GET /api/saml/auth
    SP's can have signed_response_message_requested set
      with signed_response_message_requested true
        finds Signatures in the message and assertion
        finds a Signature referencing the Response
      with signed_response_message_requested false
        only finds one Signature
        only finds a Signature referencing the Assertion

SamlCompletionController
  GET #index
    with a blank service provider request session
      renders 404 not found
    with a valid service provider request session
      renders the appropriate form
    with a nil service provider request session
      renders 404 not found

Users::VerifyPersonalKeyController
  before actions
    only allows 2fa users through
  #create
    with throttle reached
      tracks irs attempts api for relevant users
      renders throttled page
    with a valid form
      tracks irs attempts api for relevant users
      redirects to the next step of the account recovery flow
      stores that the personal key was entered in the user session
    with an invalid form
      redirects to form
      sets an error in the flash
      tracks irs attempts api for relevant users
  #new
    with throttle reached
      renders throttled page
    without password_reset_profile
      redirects user to the home page
    with password reset profile
      renders the `new` template
      displays a flash message to the user
      shows throttled page after being throttled

Users::SessionsController
  GET /active
    does not track analytics event
    when user is not present
      updates the pinged_at session key
      includes the remaining time
      sets live key to false
      includes session_expires_at
    when user is present
      returns a 200 status code
      includes the remaining key
      sets live key to true
      includes the timeout key
      renders json
      clears the Etag header
  #new
    with a new user
      tracks page visit, any alert flashes, and the Devise stored location
      renders the new template
      renders partials
        renders the return to service provider template when arriving from an SP
    with current user
      logs the user out
    with a garbage request_id
      does not blow up with a hash
      does not reflect request_id values that do not look like UUIDs
    with fully authenticated user
      redirects to the profile page
    with fully authenticated user who has a pending profile
      redirects to the verify profile page
  POST /sessions/keepalive
    does not track analytics event
    when user is present
      resets the remaining key
      clears the Etag header
      renders json
      resets the timeout key
      returns a 200 status code
      tracks session refresh visit
    when user is not present
      includes the remaining time
      sets live key to false
      includes session_expires_at
  GET /users/sign_in
    clears the session when user is not yet 2fa-ed
  DELETE /logout
    tracks a logout event
  GET /timeout
    redirects to the homepage
    tracks the timeout
    signs the user out
  POST /
    redirects to 2FA if there are no pending account reset requests
    redirects back to home page if CSRF error and referer is invalid
    redirects to the reset pending page if there are pending account reset requests
    tracks unsuccessful authentication for too many auth failures
    returns to sign in page if email is a Hash
    tracks the authentication attempt for nonexistent user
    tracks the unsuccessful authentication for existing user
    tracks the successful authentication for existing user
    tracks unsuccessful authentication for locked out user
    tracks the presence of SP request_url in session
    tracks CSRF errors
    with a user that accepted the rules of use more than 6 years ago
      redirects to the rules of user url
    IAL2 user
      caches PII in the user session
      deactivates profile if not de-cryptable
      computes one SCrypt hash for the user password and one for the PII
      caches unverified PII pending confirmation
    with user that is not up to date with rules of use
      redirects to rules of use url
    with user that is up to date with rules of use
      redirects to 2fa since there is no pending account reset rewquests
    with remember_device cookie present and valid
      tracks the cookie validity in analytics
    with remember_device cookie present but expired
      only tracks the cookie presence in analytics
    IAL1 user
      computes one SCrypt hash for the user password
  GET /logout
    tracks a logout event

FrontendLogController
  #create
    user is signed in
      succeeds
      allowlisted analytics event
        succeeds
        with payload
          succeeds
          with missing keyword arguments
            gracefully sets the missing values to nil
      empty payload
        succeeds
      for a named analytics method
        logs the analytics event without the prefix
      invalid param
        rejects a non-hash payload
        rejects a non-string event
      missing a parameter
        rejects a request without specifying event
        rejects a request without specifying payload
    anonymous user with session-associated user id
      succeeds

SignUp::CompletionsController
  #update
    IAL1
      updates verified attributes
      tracks analytics
      redirects to account page if the session request_url is removed
    IAL2
      sends the in-person proofing completion survey
      updates verified attributes
      tracks analytics
  #show
    requires service provider or identity info in session
    requires user with no session to be logged in
    requires user with session to be logged in
    requires service provider issuer in session
    user signed in, sp info present
      redirects to account page when SP request URL is not present
      IAL2
        tracks page visit
      IAL1
        tracks page visit
    renders partials
      renders show if the user has identities and no active session

SamlIdpController
  before_actions
    includes the appropriate before_actions
  #external_saml_request
    returns false for empty referer
    returns false for malformed referer
  GET /api/saml/auth
    service provider is inactive
      responds with an error page
    with invalid SAMLRequest param
      responds with "403 Forbidden"
    user has not finished verifying profile
      tracks the authentication with finish_profile==true
    user is not redirected to IdV
      tracks the authentication without IdV redirection event
    user requires ID verification
      tracks the authentication and IdV redirection event
    no IAL explicitly requested
      notes that in the analytics event
    service provider is invalid
      responds with an error page
    service provider sends unsupported NameID format
      sends the appropriate identifier for non-email NameID SPs
      sends the appropriate identifier for email NameID SPs
      sends the old user ID for legacy SPS
    with IAL1
      does not redirect the user to the IdV URL
    no matching cert from the SAML request
      notes that in the analytics event
    both service provider and authn_context are invalid
      responds with an error page
    authn_context is invalid
      renders an error page
    with missing SAMLRequest params
      responds with "403 Forbidden"
    with IALMAX and the identity is already verified
      does not redirect the user to the IdV URL
      tracks IAL2 authentication events
      contains verified attributes
      calls AttributeAsserter#build
      sets identity ial to 0
      profile is not in session
        redirects to password capture if profile is verified but not in session
    service provider has the wrong certs
      deoes not blow up
    authn_context scenarios
      authn_context is defined by sp
        returns AAL2-HSPD12 authn_context when AAL2-HSPD12 is requested
        returns AAL2-phishing-resistant authn_context when AAL2-phishing-resistant requested
        returns default AAL authn_context when IAL1 is requested
        returns default AAL authn_context when default AAL and IAL1 is requested
        returns AAL3 authn_context when AAL3 is requested
        returns AAL3-HSPD12 authn_context when AAL3-HSPD12 is requested
        returns AAL2 authn_context when AAL2 is requested
      authn_context is missing
        returns saml response with default AAL in authn context
    nameid_format is missing
      defaults to persistent
      defaults to email when added to issuers_with_email_nameid_format
    POST to auth correctly stores SP in session
      stores SP metadata in session
      correctly sets the request URL
    HEAD /api/saml/auth
      responds with "403 Forbidden"
    SAML Response
      returns a Success status code
      returns a valid xml document
      includes an Issuer element inherited from the base URL
      sets correct CSP config that includes any custom app scheme uri from SP redirect_uris
      includes a Status element with a StatusCode child element
      includes the required StatusCode
      ds:Signature
        includes a X509Certificate element
        includes the ds:Signature element with the signature namespace
        includes a KeyInfo element
        includes a SignatureValue element
        includes the saml cert from the certs folder
        includes a X509Data element
      SignedInfo
        includes a DigestMethod element
        includes a SignatureMethod element specifying rsa-sha256
        has valid signature
        includes a CanonicalizationMethod element
        includes a SignedInfo element
        Reference
          includes a URI attribute
          includes a Reference element
      Subject
        has a saml:Subject element
        NameID
          has the UUID of the user making the AuthN Request
          has a format attribute specifying the email format
          has a saml:NameID element
        SubjectConfirmation
          has a method attribute specifying the bearer method
          has a SubjectConfirmation element
          SubjectConfirmationData
            has a Recipient attribute
            has a SubjectConfirmationData element
            has an InResponseTo attribute
            has a NotOnOrAfter attribute
      AuthnContext
        has a saml:AuthnContext element
        AuthnContextClassRef
          has contents set to AAL2
          has a saml:AuthnContextClassRef element
      saml:AttributeStatement
        does not include the phone Attribute element when authn_context is IAL1
        includes the saml:AttributeStatement element
        includes the uuid Attribute element
        includes the email Attribute element
      Assertion
        includes an IssueInstant attribute with a timestamp
        includes an ID attribute with a valid UUID
        includes the xmlns:saml attribute in the element
        includes an Version attribute set to v2.0
      Transforms
        includes a Transform specifying the Schema for XML Signatures
        includes a Transform specifying the Canonical XML serialization
        includes a Transforms element specifying multiple transformation algorithms
      AuthnStatement
        has a SessionIndex attribute
        has an AuthnInstant attribute
        has a saml:AuthnStatement element
      Conditions
        has a NotBefore attribute
        has a NotOnOrAfter attribute
        has a saml:Conditions element
    service provider uses email NameID format but is not allowed to use email
      returns an error
    after signing in
      does not call IdentityLinker
    service provider uses email NameID format and is allowed to use email
      Subject
        has a saml:Subject element
        NameID
          has NameID value of the email address of the user making the AuthN Request
          has a format attribute defining the NameID to be email
          has a saml:NameID element
    service provider has multiple certs
      encrypts the response to the right key
    service provider is valid
      stores SP metadata in session
      after successful assertion of ial1
        does not delete SP metadata from session
        redirects to verify attributes
        does not redirect after verifying attributes
        does not create an identity record until the user confirms attributes
        redirects if verified attributes dont match requested attributes
    when user is not logged in
      redirects the user to the SP landing page with the request_id in the params
      logs SAML Auth Request but does not log SAML Auth
    ForceAuthn set to true
      signs the user out if a session is active
    with IAL2 and the identity is already verified
      behaves like a verified identity
        does not redirect the user to the IdV URL
        contains verified attributes
        calls AttributeAsserter#build
        sets identity ial
        tracks IAL2 authentication events
        profile is not in session
          redirects to password capture if profile is verified but not in session
    with IAL2 and the profile is reset
      redirects to IdV URL for IAL2 proofer
  /api/saml/logout
    accepts requests from a correct cert
    tracks the event when sp initiated
    rejects requests from a wrong cert
    tracks the event when the saml request is invalid
    tracks the event when idp initiated
  /api/saml/remotelogout
    tracks the event when the saml request is invalid
    rejects requests from a wrong cert
    rejects requests from a correct cert but a non-associated user
    rejects requests from a correct cert but no session index
    accepts requests with correct cert and correct session index and renders logout response
    rejects requests from a correct cert but bad session index
  /api/saml/metadata
    contains a signature method nodeset with SHA256 algorithm
    contains the org display name under AttributeAuthorityDescriptor
    contains the organization name
    contains a digest method nodeset with SHA256 algorithm
    contains a signature nodeset
    renders XML inline
    contains the correct NameID formats
    disables caching
    contains the organization name under AttributeAuthorityDescriptor
    contains an EntityDescriptor nodeset
    contains the organization display name

AccountReset::ConfirmDeleteAccountController
  #show
    no email in session
      redirects to the new user registration path
    email in session
      renders the page and deletes the email from the session

TwoFactorAuthentication::BackupCodeVerificationController
  #show
    tracks the page visit
  #create
    when the user enters an invalid backup code
      re-renders the backup code entry screen
      tracks the max attempts event
    when the backup code field is empty
      renders the show page
    when the user enters a valid backup code
      tracks the valid authentication event when there are exisitng codes
      tracks the valid authentication event

IdvController
  #index
    redirects to account recovery if user has a password reset profile
    redirects to doc auth if doc auth is enabled and exclusive
    tracks page visit
    does not track page visit if profile is active
    redirects to failure page if number of attempts has been exceeded
    no SP context
      sp not required
        begins the identity proofing process
      sp required
        redirects back to the account page
        user has an existing profile
          begins the identity proofing process
    with a VA inherited proofing session
      redirects to inherited proofing
  #activated
    user does not have an active profile
      does not allow direct access
    user has an active profile
      allows direct access

SignUp::CancellationsController
  #destroy
    redirects if no user is present
    destroys the current_user if user has set password but not added 2FA
    redirects if user has completed sign up
    calls ParseControllerFromReferer
    redirects to the branded start page if the user came from an SP
    redirects if confirmation_token is expired
    redirects if confirmation_token is invalid
    tracks the event in analytics when referer is nil
    tracks the event in analytics when referer is present
  #new
    tracks the event in analytics when referer is nil
    tracks the event in analytics when referer is present

OpenidConnect::CertsController
  #index
    sets HTTP headers to cache for a week
    renders the server public key as a JWK set

Idv::ComeBackLaterController
  user does not need USPS address verification
    redirects to the account path
  user needs USPS address verification
    renders the show template

Test::DeviceProfilingController
  #create
    sets the result in redis
  #index
    sets no_result for the session_id

VerifySpAttributesConcern
  #consent_has_expired?
    when last_consented_at is nil but created_at is within a year
      is false
    when the last_consented_at is older than a year ago
      is true
    when there is no sp_session_identity
      is false
    when there is no last_consented_at
      is true
    when last_consented_at within one year
      is false
    when there is an active profile
      when the active profile was verified after last_consented_at
        is true because the new verified data needs to be consented to sharing
      when the active profile was verified before last_consented_at
        is false
    when the identity has been soft-deleted (consent has been revoked)
      is false
    when last_consented_at is nil and created_at is older than a year
      is true
  #needs_completion_screen_reason
    with an issuer
      when the sp_session_identity has been saved
        when requested attributes are nil
          is nil
        when requested attributes are verified
          is nil
        when requested attributes exist and are not verified
          is :new_attributes
      when the sp_session_identity has not been saved
        is :new_sp
    without an issuer
      is nil
  #consent_was_revoked?
    when there is no sp_session_identity
      is false
    when the sp_session_identity exists and has been deleted
      is false
    when the sp_session_identity exists and has not been deleted
      is false

MfaConfirmationController
  #show
    presents the mfa confirmation page.
  password attempts counter
    last password attempt is correct
      does not sign the user out
    max password attempts reached
      signs the user out
  #new
    does not reset password attempts if already set
    presents the password confirmation form
  #create
    password is wrong
      redirects with error message and increments password attempts
      session data is missing
        redirects and increments the password count
    password is empty
      redirects with error message and increments password attempts
    password is correct
      redirects to 2FA and resets password attempts

Idv::CaptureDocController
  before_actions
    includes corrects before_actions
  #index
    with no session
      redirects to the root url
    with a bad session
      redirects to the root url
    with a user id in session and no session uuid
      redirects to the first step
    with an expired token
      redirects to the root url
    with a good session uuid
      redirects to the first step
  #show
    with a user id in session
      renders the capture_complete template
      tracks expected events for irs reproofing
      renders a 404 with a non existent step
      renders the document_capture template
      increments the analytics step counts on subsequent submissions
      tracks expected events

Users::RulesOfUseController
  #create
    when the user needs to accept the rules of use and does not accept them
      redirects to the two factor authentication page
      logs a failure analytics event
      does not updates the user accepted terms at timestamp
    when the user needs to accept the rules of use and does accept them
      updates the user accepted terms at timestamp
      logs a successful analytics event
      redirects to the two factor authentication page
  before_actions
    includes appropriate before_actions
  #new
    with a user who is not up to date with rules of use
      renders
      logs an analytics event for visiting
    with a user that has accepted the rules of use
      redirects to mfa
    with a user that has not accepted the rules of use
      renders
      logs an analytics event for visiting
    with no user signed in
      redirects to root
    with a user who is up to date with rules of use
      redirects to mfa

AccountReset::ConfirmRequestController
  #show
    email is present in flash
      renders the show template
    no email in flash
      redirects to the new user registration path

TwoFactorAuthentication::SmsOptInController
  #create
    when loaded while using an existing phone
      when resubscribing is successful
        redirects to the otp send controller
        deletes the opt out row
      when resubscribing throws an error
        renders the form with a flash error
        does not delete the opt out row
      when resubscribing is not successful
        renders an error
        does not delete the opt out row
    when loaded without any phone context
      renders a 404
  #new
    when loaded while using an existing phone
      tracks a visit event
      when the user has other auth methods
        has an other mfa options url
      when the user is signing in through an SP
        points the cancel link back to the SP
    when loaded while adding a new phone
      assigns an in-memory phone configuration
    when loaded without any phone context
      renders a 404

PagesController
  analytics
    does not load session
    renders without a layout
    returns 404 status
  content expiry
    does not set headers to disable cache

Users::DeleteController
  #show
    shows and logs a visit
  #delete
    deletes profile information for ial2
    does not delete identities to prevent uuid reuse
    redirects to the root path
    deletes user
    logs a succesful submit
    with an incorrect password
      flashes a banner and renders the form
      logs a failed submit
      does not delete the user

IdvStepConcern
  #confirm_idv_needed
    user does not have active profile
      does not redirect to activated page
    user has active profile
      redirects to activated page
  #confirm_idv_session_started
    user has started IdV session
      allows request
    user has not started IdV session
      redirects to idv doc auth url

Users::ResetPasswordsController
  #edit
    no user matches token
      redirects to page where user enters email for password reset token
    token expired
      redirects to page where user enters email for password reset token
    token is valid
      displays the form to enter a new password and disallows indexing
  #create
    renders new if email is a Hash
    renders new if email is nil
    no user matches email
      send an email to tell the user they do not have an account yet
    user exists but is unconfirmed
      sends password reset email to user and tracks event
    email is invalid
      displays an error and tracks event
    user is verified
      captures in analytics that the user was verified
    user exists
      sends password reset email to user and tracks event
  #update
    user submits new password after token expires
      redirects to page where user enters email for password reset token
    ial2 user submits valid new password
      deactivates the active profile and redirects
    user submits the reset password form twice
      shows an invalid token error
    user submits invalid new password
      renders edit
    IAL1 user submits valid new password
      redirects to sign in page
    unconfirmed user submits valid new password
      confirms the user
  #new
    logs visit to analytics

SignOutController
  #destroy
    redirects to decorated_session.cancel_link_url with flash message
    tracks the event
    calls #sign_out and #delete_branded_experience

Risc::SecurityEventsController
  #create
    tracks an successful in analytics
    creates a security event record
    with a bad request
      renders an error response and does not create a security event record
      tracks an error event in analytics

Users::EmailConfirmationsController
  #create
    Valid email confirmation tokens
      tracks a valid email confirmation token event
      rejects invalid tokens
      rejects expired tokens
      rejects an otherwise valid token for unconfirmed users

TwoFactorAuthentication::PivCacVerificationController
  #show
    when the user presents a different piv/cac
      displays flash error message
      redirects to the piv/cac entry screen
      resets the piv/cac session information
      increments second_factor_attempts_count
    when the user has reached the max number of piv/cac attempts
      tracks the event
    when the user does not have a piv/cac associated
      and a token is provided
        redirects to user_two_factor_authentication_path
      and no token is provided
        redirects to user_two_factor_authentication_path
    when the user lockout period expires
      when user submits a valid piv/cac
        resets attempts count
        resets second_factor_locked_at
      when user submits an incorrect piv/cac
        resets the x509 session information
        resets attempts count
        resets second_factor_locked_at
    before the user presents a valid PIV/CAC
      renders a page with a submit button to capture the cert
    when the user presents a valid PIV/CAC
      resets the second_factor_attempts_count
      tracks the valid authentication event
      redirects to the profile
    when the user presents an invalid piv/cac
      displays flash error message
      redirects to the piv/cac entry screen
      resets the piv/cac session information
      increments second_factor_attempts_count

Health::OutboundController
  #index
    when the outbound connections are uhealthy
      is a 500
      renders the error
    when the outbound connections are healthy
      is a 200
      renders the result

ForgotPasswordController
  #show
    email in session
      renders the page
    no email in session
      redirects to the new user password path

Idv::CancellationsController
  #new
    tracks the event in analytics when step param is present
    tracks the event in analytics when referer is present
    tracks the event in analytics when referer is nil
    when hybrid session
      renders template
      stores go back path
    when no session
      redirects to root
    when regular session
      stores go back path
      renders template
  before_actions
    includes before_actions from IdvSession
  #update
    logs cancellation go back
    redirects to idv_path
    with go back path stored in session
      redirects to go back path
  #destroy
    tracks an analytics event
    when no session
      redirects to root
    when hybrid session
      cancels document capture
      renders template
    when regular session
      renders template
      destroys session
      with in person enrollment
        deletes in person flow data
        cancels pending in person enrollment
        cancels establishing in person enrollment

AccountReset::DeleteAccountController
  #show
    redirects to root if the token does not match one in the DB
    renders the show view if the token is missing
    displays a flash and redirects to root if the token is expired
  #delete
    redirects to root if the token does not match one in the DB
    logs a good token to the attempts api
    displays a flash and redirects to root if the token is missing
    logs a good token to the analytics
    logs an error in irs attempts tracker
    displays a flash and redirects to root if the token is expired

Idv::InheritedProofingController
  when VA inherited proofing mock is not enabled
    behaves like the flow steps work correctly
      #index
        redirects to the first step
        when the inherited proofing feature flag is disabled
          returns 404 not found
      #show
        redirects to the configured next step
        redirects to the first step if a non-existent step is given
        renders the correct template
  when VA inherited proofing mock is enabled
    behaves like the flow steps work correctly
      #show
        renders the correct template
        redirects to the configured next step
        redirects to the first step if a non-existent step is given
      #index
        redirects to the first step
        when the inherited proofing feature flag is disabled
          returns 404 not found

AccountReset::RequestController
  #create
    logs totp user in the analytics
    logs sms user in the analytics
    logs PIV/CAC user in the analytics
    logs the visit to attempts api
    redirects to 2FA setup url if 2FA not set up
    redirects to root if user not signed in
  #show
    renders the page
    logs the visit to analytics
    redirects to 2FA setup url if 2FA not set up
    redirects to root if user not signed in

Top 10 slowest examples (19.65 seconds, 8.4% of total time):
  Users::PasswordsController#update form returns success sends a security event
    4.41 seconds ./spec/controllers/users/passwords_controller_spec.rb:52
  Users::PasswordsController#update form returns success calls UpdateUserPassword
    3.19 seconds ./spec/controllers/users/passwords_controller_spec.rb:25
  Users::PasswordsController#update form returns success redirects to profile and sends a password change email
    2.47 seconds ./spec/controllers/users/passwords_controller_spec.rb:6
  TwoFactorAuthentication::BackupCodeVerificationController#create when the user enters a valid backup code tracks the valid authentication event when there are exisitng codes
    1.7 seconds ./spec/controllers/two_factor_authentication/backup_code_verification_controller_spec.rb:46
  TwoFactorAuthentication::OtpVerificationController#create phone confirmation with remember_device in the params saves an encrypted cookie
    1.41 seconds ./spec/controllers/two_factor_authentication/otp_verification_controller_spec.rb:591
  Users::TotpSetupController#new user is setting up authenticator app during account creation can be used to generate a qrcode with UserDecorator#qrcode
    1.41 seconds ./spec/controllers/users/totp_setup_controller_spec.rb:66
  SamlIdpController /api/saml/remotelogout accepts requests with correct cert and correct session index and renders logout response
    1.34 seconds ./spec/controllers/saml_idp_controller_spec.rb:225
  Users::EmailConfirmationsController#create Valid email confirmation tokens tracks a valid email confirmation token event
    1.29 seconds ./spec/controllers/users/email_confirmations_controller_spec.rb:6
  TwoFactorAuthentication::OtpVerificationController#create phone confirmation user has an existing phone number user enters a valid code tracks the update event and notifies via email about number change
    1.24 seconds ./spec/controllers/two_factor_authentication/otp_verification_controller_spec.rb:418
  SamlIdpController /api/saml/remotelogout rejects requests from a correct cert but bad session index
    1.18 seconds ./spec/controllers/saml_idp_controller_spec.rb:297

Top 10 slowest example groups:
  Users::PasswordsController
    1.33 seconds average (11.97 seconds / 9 examples) ./spec/controllers/users/passwords_controller_spec.rb:3
  TwoFactorAuthentication::BackupCodeVerificationController
    0.64584 seconds average (3.88 seconds / 6 examples) ./spec/controllers/two_factor_authentication/backup_code_verification_controller_spec.rb:3
  Users::EmailConfirmationsController
    0.50702 seconds average (2.03 seconds / 4 examples) ./spec/controllers/users/email_confirmations_controller_spec.rb:3
  AccountReset::PendingController
    0.42568 seconds average (1.28 seconds / 3 examples) ./spec/controllers/account_reset/pending_controller_spec.rb:3
  SamlIdpController
    0.38028 seconds average (50.2 seconds / 132 examples) ./spec/controllers/saml_idp_controller_spec.rb:3
  Users::BackupCodeSetupController
    0.35081 seconds average (2.46 seconds / 7 examples) ./spec/controllers/users/backup_code_setup_controller_spec.rb:3
  Accounts::PersonalKeysController
    0.32759 seconds average (1.64 seconds / 5 examples) ./spec/controllers/accounts/personal_keys_controller_spec.rb:3
  Risc::SecurityEventsController
    0.32577 seconds average (1.3 seconds / 4 examples) ./spec/controllers/risc/security_events_controller_spec.rb:3
  AccountReset::DeleteAccountController
    0.32198 seconds average (2.9 seconds / 9 examples) ./spec/controllers/account_reset/delete_account_controller_spec.rb:3
  Users::EmailsController
    0.32123 seconds average (1.28 seconds / 4 examples) ./spec/controllers/users/emails_controller_spec.rb:3

Finished in 3 minutes 52.8 seconds (files took 2.19 seconds to load)
1360 examples, 0 failures

Randomized with seed 36668

Coverage report generated for RSpec to /home/jmax/projects/identity-idp/coverage. 14967 / 26940 LOC (55.56%) covered.


Randomized with seed 22313

FeatureManagement
  #disallow_all_web_crawlers?
    returns true when IdentityConfig setting is true
    returns false when IdentityConfig setting is false
  #prefill_otp_codes?
    when SMS sending is disabled
      returns true in development mode
      returns false in non-development mode
    in production servers
      when the server is in sandbox
        prefills codes
      when the server is in production
        does not prefill codes
    when SMS sending is enabled
      returns false in non-development mode
      returns false in production mode when server is pt
      returns false in development mode
  #use_kms?
    when enabled
      enables the feature
  #reveal_gpo_code?
    server domain name is dev, qa, or int
      returns true
    Rails env is development
      returns true
    Rails env is not development and server is not dev, qa, or int
      returns false
  .show_demo_banner?
    in a deployed environment
      in a non-prod env
        is true
      in production
        is false
    in local development
      is false
  piv/cac feature
    #identity_pki_disabled?
      when enabled
        has the feature disabled
      when disabled
        has the feature disabled
    #development_and_identity_pki_disabled?
      in development environment
        identity_pki disabled
          returns true
        identity_pki not disabled
          returns false
      in production environment
        identity_pki not disabled
          returns false
        identity_pki disabled
          returns false
  .show_no_pii_banner?
    in local development
      is false
    in a deployed environment
      in the prod domain
        is false
      in the sandbox domain
        is true
  .voip_allowed_phones
    normalizes phone numbers and put them in a set
  #document_capture_async_uploads_enabled?
    returns false when IdentityConfig presigned S3 URL setting is false
    returns true when IdentityConfig presigned S3 URL setting is true
  #use_dashboard_service_providers?
    when disabled
      disables the feature
    when enabled
      enables the feature
  log_to_stdout?
    outside the test environment
      returns false when disabled
      returns true when enabled
    in the test environment
      always returns true
  #identity_pki_local_dev?
    when in non-development mode
      returns false when IdentityConfig setting is true
      returns false when IdentityConfig setting is false
    when in development mode
      returns true when IdentityConfig setting is true
      returns false when IdentityConfig setting is false

Telephony::Test::Call
  #otp
    the call does not contain an OTP
      returns nil
    the call contains an OTP
      returns the OTP
  .last_otp
    with alphanumeric OTPs
      returns the most recent ones
    without a phone number
      returns the most recent OTP for any phone number
    when there have been no calls
      returns nil
    with a phone number
      returns the most recent OTP for that phone number

DataRequests::CreateMfaConfigurationsReport
  #call
    includes an array with backup codes
    includes an array for security keys
    includes an array for piv/cac cards
    includes an array for authentication apps
    includes an array for phone numbers

SessionEncryptor
  #load
    with a legacy session ciphertext
      decrypts the legacy session
    with version 2 encryption enabled
      decrypts the new version of the session
  #kms_encrypt_sensitive_paths!
    encrypts/decrypts transparently
  #dump
    with version 2 encryption enabled
      can decrypt PII bundle with Pii::Cacher
      raises if reserved key is used
      transparently encrypts/decrypts sensitive elements of the session
      raises if sensitive value is not KMS encrypted
      KMS encrypts/decrypts doc auth elements of the session
      raises if PII key appears outside of expected areas when alerting is disabled
      sends alert if PII key appears outside of expected areas if alerting is enabled
      encrypts decrypted_pii bundle without automatically decrypting
    without version 2 encryption enabled
      encrypts the session with the legacy encryptor

RuboCop::Cop::IdentityIdp::RedirectBackLinter
  registers offenses when calling redirect_back with only fallback location
  registers offenses when calling redirect_back with only allow_other_host set to false
  registers offenses when calling redirect_back with no arguments
  registers no offense when including Rails url_helpers and defining url_options

dev rake tasks
  dev:prime
    runs successfully
  dev:random_in_person_users
    can create passed enrollments
    defaults to MAX_NUM_ATTEMPTS=3 if not specified
    runs successfully, defaults to pending
    can create cancelled enrollments
    can create expired enrollments
    stops retrying after MAX_NUM_ATTEMPTS attempts and fails the transaction
    waits between USPS IPPaaS requests when USPS_REQUEST_DELAY_MS is set
    waits USPS_REQUEST_DELAY_MS ms between retries
    can create establishing enrollments
    retries when it gets an error from USPS
    creates the enrollment in USPS IPPaaS when CREATE_PENDING_ENROLLMENT_IN_USPS is truthy
    skips previously added pending enrollments
    can create failed enrollments
  dev:random_users
    runs successfully
    skips previously added users
    skips previously verified users

Telephony::Pinpoint::OptOutManager
  #opt_in_phone_number
    when opting in is not successful in one region (already opted in w/in last 30 days)
      returns a response that is unsuccessful, but has no error
    when there is a network error in one region
      returns an unsuccessful response with an error
    when opting in is successful in all regions
      has a successful response
    with no region configs
      is an unsuccessful response
  #opted_out_numbers
    iterates phone numbers across regions

Utf8Sanitizer
  with valid strings
    passes through
  with invalid utf8
    400s with nested bad params
    400s
  null bytes
    allows null bytes inside of files
    blocks null bytes inside the body
    blocks null bytes in the params
    blocks null bytes in the keys of params

AnalyticsEventsDocumenter
  #as_json
    is a JSON representation of params for each event
    with a namespaced class name, with symbol event names
      still finds events
  .run
    with --json
      prints json output
    with --help
      prints help
    with --check
      prints a rocket when there are no errors
  #missing_documentation
    when all methods have all documentation
      is empty
    when a method has * as its only arg
      errors
    when a method skips documenting an param, such as pii_like_keypaths
      allows documentation to be missing
    when a method includes a positional param
      reports the invalid param
    when a method is missing an event name
      reports the missing tag
    when a method is missing documentation for a param
      reports the missing tag
    when a method does not have a **extra param
      requires **extra param
      when require_extra_params is false
        allows **extra to be missing

Base16
  with a less reasonable input
    given a zany-face emoji
      returns the same bytes
  with reasonable inputs
    given "Hello, World"
      returns a known value
      returns a value with uppercase letters
    given a sequence of zeroes
      does not truncate them

Telephony::Util
  .duration_ms
    is the duration in whole milliseconds between two times

MakefileHelpParser
  #build_target_comments
    is a mapping of target to its line number and comment
  #parse_rules
    is the full list of rules
  #build_expanded_targets
    is a mapping of line numbers to targets

IdentityJobLogSubscriber
  logs events
  logs errors when exception occurs in job
  #enqueue_at
    does report the duplicate key error as an exception
    is compatible with job classes that do not inherit from ApplicationJob
    logs warnings when exception occurs in job with warning error classes
    halts
    processes as normal
  #enqueue_retry
    includes exception if there is a failure
    formats retry message
  #enqueue
    logs warnings when exception occurs in job with warning error classes
    processes as normal
    does not report the duplicate key error as an exception
    halts
  #discard
    logs warnings when exception occurs in job with warning error classes

RuboCop::Cop::IdentityIdp::ImageSizeLinter
  registers no offense when calling image_tag with width and height
  registers no offense if there is ambiguous hash splatting
  registers offense when calling image_tag without any size attributes
  registers no offense when calling image_tag with size
  registers offense when calling image_tag with only one of width or height

DataRequests::WriteCloudwatchLogs
  #call
    writes the logs to output_dir/logs.csv
    missing data
      does not blow up
    various multi factor ids
      unpacks all multi factor ids

Telephony
  .sms_parts
    correctly calculates number of parts in non-GSM messages
    correctly calculates number of parts in more complicated GSM messages
    correctly calculates number of parts in simple GSM messages
  .sms_character_length
    calculates correct length of more complicated GSM messages
    calculates correct length of simple GSM messages
    calculates correct length of messages containing emoji
    calculates correct length of messages containing non-GSM characters
  .phone_info
    with test adapter
      uses the test adapter
    with pinpoint adapter
      uses the pinpoint adapter

Telephony::OtpSender
  with the test adapter
    for Voice
      saves the OTP that was sent for authentication
      saves the OTP that was sent for confirmation
    for SMS
      saves the OTP that was sent for authentication
      logs a message being sent
      saves the OTP that was sent for confirmation
  #confirmation_message
    voice
      English
        behaves like pinpoint valid SSML message
          does not contain reserved SSML characters
      Spanish
        behaves like pinpoint valid SSML message
          does not contain reserved SSML characters
      French
        behaves like pinpoint valid SSML message
          does not contain reserved SSML characters
    sms
      Spanish
        is sent in three parts
      English
        does not contain any non-GSM characters and is sent in one part
      French
        does not contain any non-GSM characters and is sent in one part
  #otp_transformed_for_channel
    for voice
      with a numeric code
        is the code separated by commas
      with an alphanumeric code
        is the code separated by commas
    for sms
      is the code
  with the pinpoint adapter
    for voice
      sends a confirmation OTP with Pinpoint Voice
      sends valid XML
      sends an authentication OTP with Pinpoint Voice
    for SMS
      sends a confirmation OTP with Pinpoint SMS
      sends an authentication OTP with Pinpoint SMS
  #authentication_message
    voice
      English
        behaves like pinpoint valid SSML message
          does not contain reserved SSML characters
      Spanish
        behaves like pinpoint valid SSML message
          does not contain reserved SSML characters
      French
        behaves like pinpoint valid SSML message
          does not contain reserved SSML characters
    sms
      English
        does not contain any non-GSM characters and is less than or equal to 160 characters
      French
        does not contain any non-GSM characters and is less than or equal to 160 characters
      Spanish
        is sent in three parts

DataRequests::WriteUserEvents
  #call
    writes a file with event information

partners rake tasks
  partners:get_agency_uuids
    with all ENV variables
      displays a helpful error message with errors
      exits with errors
4 users reported
Complete!
      works with valid input
    with missing SP_FILE
      displays an error message
      exits
    with missing OUTPUT
      displays an error message
      exits
    with missing EMAIL_FILE
      displays an error message
      exits
  partners:seed_users
    with both ENV variables
      displays a helpful error message with errors
      exits with errors
2 users created
Complete!
      works with valid input
    with missing EMAIL_DOMAIN
      displays an error message
      exits
    with missing CSV_FILE
      exits
      displays an error message

AbTestBucket
  configured with buckets adding up to exactly 100 percent
    divides random uuids into the buckets with no automatic default
  configured with buckets with string percentages
    converts string percentages to numbers and returns the correct result
  misconfigured with buckets in the wrong data structure
    raises a RuntimeError
  configured with buckets adding up to more than 100 percent
    raises a RuntimeError
  configured with buckets with random strings
    converts string to zero percent and returns :default
  configured with no buckets
    returns :default
  configured with buckets adding up to less than 100 percent
    sorts uuids into the buckets

Aws::SES::Base
  #deliver!
    sends the message to the correct recipients
    sets the message id on the mail argument
    retries timed out requests

DataRequests::WriteUserInfo
  #call
    writes a file with user information

Deploy::Activate
  outside a deployed production environment
    errors
  in a deployed production environment
    uses a default logger with a progname
    does not re-download pwned password files if they already exist
    does not re-download GeoIP files if they already exist
    downloads the pwned passwords and geolite files from s3

RuboCop::Cop::IdentityIdp::UrlOptionsLinter
  registers an offense when including Rails url_helpers
  registers no offense when including Rails url_helpers and defining url_options
  registers no offense when including Rails url_helpers and defining attr_accessor
  registers no offense when including Rails url_helpers and defining attr_reader

rotate
  attribute_encryption_key
    outputs diagnostic information on users that throw exceptions
    does not raise an exception when encrypting/decrypting a user
    runs successfully

Telephony::Response
  for a failed response
    can be serialized into a hash
    is not successful
    returns an errors hash
  for a successful response
    is successful
    returns an empty errors hash
    can be serialized into a hash

Telephony::Pinpoint::SmsSender
  error handling
    when the request is throttled
      raises an opt out error
    when an unkown error occurs
      raises an opt out error
    when a temporary failure occurs
      raises an opt out error
    when the API responds with an unrecognized error
      raises a generic telephony error
    when a timeout exception is raised
      handles the exception
    when the user opts out
      raises an opt out error
    when a permanent failure occurs
      raises a permanent failure error
      when the message indicates opt out
        raises an OptOutError instead
    when the request times out
      raises an opt out error
    when endpoint is a duplicate
      raises a duplicate endpoint error
  #phone_info
    when the first config raises a timeout exception
      logs a warning for each failure and tries the other configs
    when all configs raise errors
      logs a warning for each failure and returns unknown
    successful network requests
      has the carrier
      has a blank error
      when the phone number is a landline number
        is expected to eq :landline
      when the phone number is some unhandled type
        is expected to eq :unknown
      when the phone number is a voip number
        is expected to eq :voip
      when the phone number is a mobile number
        is expected to eq :mobile
  #send
    when the exception message contains a phone number
      does not include the phone number in the results
    in a country with sender_id
      sends a message with a sender_id and no origination number
    with multiple sms configs
      when the first config succeeds
        only tries one client
      when the first config raises a timeout exception
        logs a warning for each failure and tries the other configs
      when the first config errors with a permanent error
        only tries one region and returns an error
      when the first config errors with an opt out error
        only tries one region and returns an error
      when the first config errors with a transient error
        logs a warning for each failure and tries the other configs
    in the US
      sends a message with a shortcode and no sender_id
    in a non-sender_id country that has a configured long code pool
      sends a message with a longcode and no sender_id

QueryTracker
  #track
    tracks queries with complex joins
    tracks queries

Telephony::Test::VoiceSender
  #send
    adds the call to the call stack
    simulates a telephony error
    simulates an invalid calling area error

DataRequests::FetchCloudwatchLogs
  fails if run in a deployed environment
  starts queries for each date and returns processed results

HeadersFilter
  #call
    removes untrusted headers from the env

DataRequests::CreateUserEventsReport
  #call
    returns an array of hashes representing the users events

DataRequests::CreateUserReport
  returns a report containing information about
  with a requesting SP issuer provided
    includes the UUID for a SP if one exists
    includes the ID of the user if the user is not associated with the agency

DataRequests::LookupSharedDeviceUsers
  #call
    recursively looks up users sharing devices

RuboCop::Cop::IdentityIdp::LocalizedValidationMessageLinter
  validation helper
    registers an offense when using static translated string as validation message
    registers no offense when using proc as validation message
  plain validation
    registers no offense when using proc as validation message
    registers an offense when using static translated string as validation message

Fingerprinter
  .fingerprint_cert
    ssl_cert is present
      returns a hexdigest of the cert
    ssl_cert is nil
      returns nil

RuboCop::Cop::IdentityIdp::MailLaterLinter
  does not register offenses for the ReportMailer
  registers offense when calling deliver_now method
  registers offense when calling deliver_later method
  registers offense when calling .with(...).deliver_now method

IdentityConfig
  .key_types
    has all _timeout keys as numbers
    has all _at keys as timestamps
    has all _enabled keys as booleans

Telephony::Test::Message
  .last_otp
    with alphanumeric OTPs
      returns the most recent ones
    when there have been no messages
      returns nil
    with a phone number
      returns the most recent OTP for that phone number
    without a phone number
      returns the most recent OTP for any phone number
  #otp
    the message does not contain an OTP
      returns nil
    the message contains an OTP
      returns the OTP

DataRequests::CreateEmailAddressesReport
  #call
    returns an array with hashes representing the users email addresses

AssetSources
  .get_assets
    loads the manifest once
    returns unique, flattened assets
    uncached manifest
      loads the manifest
    unset manifest
      returns an empty array
  .load_manifest
    sets the manifest
    invalid json
      gracefully sets nil manifest
    missing file
      gracefully sets nil manifest
  .get_sources
    loads the manifest once
    returns unique localized assets for existing sources, in order, localized scripts first
    uncached manifest
      loads the manifest
    unset manifest
      returns an empty array
  .get_integrity
    returns the integrity hash
    a path which does not exist in the manifest
      returns nil

RuboCop::Cop::IdentityIdp::ErrorsAddLinter
  registers an offense when no type options are passed
  registers an offense when no options are passed
  does not register an offense for non "errors" add methods
  registers no offense when including a symbol "type" error

OtpCodeGenerator
  .generate_alphanumeric_digits
    pads short strings with zeroes
    filters out profanity
    generates crockford-32 encoded words
  .generate_digits
    pads short strings with zeroes

Telephony::AlertSender
  send_account_reset_notice
    sends the correct message
  send_personal_key_regeneration_notice
    sends the correct message
  send_account_reset_cancellation_notice
    sends the correct message
  send_personal_key_sign_in_notice
    sends the correct message
  send_doc_auth_link
    warns if the link is longer than 160 characters
    sends the correct message
    in locale fr
      puts the URL in the first 160 characters, so it stays within a single SMS message
    in locale es
      puts the URL in the first 160 characters, so it stays within a single SMS message
    in locale en
      puts the URL in the first 160 characters, so it stays within a single SMS message

AppArtifacts::Store
  #method_missing
    runs methods based on the configd artifact keys
  #add_artifact
    allows a block to be used to transform values
    when running locally
      reads the artifact from the example folder
      raises an error if an artifact is missing
    when in a deployed environment
      reads the artifact from the secrets S3 bucket
      raises an error if an artifact is missing

Telephony::Pinpoint::AwsCredentialBuilder
  with assumed roles in the config
    returns an assumed role credential
    returns nil if STS raises a Seahorse::Client::NetworkingError
  with aws credentials in the config
    returns a plain old credential object
  with no credentials in the config
    returns nil

DataRequests::LookupUserByUuid
  #call
    when a user exists with the UUID
      returns the user
    when an identity exists with the UUID
      returns the user for the identity
    when nothing exists for the UUID
      returns nil

PinpointSupportedCountries
  #sms_support
    parses the SMS page from poinpoint an array of configs
    when we do not have a sender ID for a country that requires one
      is supported
  PinpointSupportedCountries::TableConverter
    #convert
      converts an HTML table into an array of hashes
  #run
    returns a hash that matches the structure of country_dialing_codes.yml
  #country_code
    is only the country code if the leading digits have a regex
    adds the leading digits if they are all digits
  #load_country_dialing_codes
    combines sms and voice support and country code into a shared config
  #voice_support
    parses the voice page from poinpoint an array of configs
  PinpointSupportedCountries::CountrySupport
    #merge
      combines two structs by ||-ing the attributes

Telephony::Pinpoint::VoiceSender
  #send
    initializes a pinpoint sms and voice client and uses that to send a message
    when pinpoint responds with an internal service error
      returns a telephony error
    when pinpoint responds with a generic error
      returns a telephony error
    when pinpoint responds with a TooManyRequestsException
      returns a DailyLimitReachedError
    with multiple voice configs
      when the first config succeeds
        only tries one client
      when the first config errors
        logs a warning and tries the other configs
    when pinpoint responds with a limit exceeded response
      returns a telephony error
    when the current locale is french
      calls the user with a french voice
    when the current locale is spanish
      calls the user with a spanish voice
    when pinpoint raises a timeout exception
      rescues the exception and returns an error

Telephony::Test::SmsSender
  #phone_info
    generating a voip phone number
      has an error response
    generating an error response
      has an error response
    with a phone number that does not generate errors
      has a successful response
  #send
    adds the message to the message stack
    simulates a telephony error
    simulates an invalid calling area error
    simulates an invalid phone number error

Top 10 slowest examples (17.27 seconds, 41.8% of total time):
  dev rake tasks dev:random_in_person_users waits between USPS IPPaaS requests when USPS_REQUEST_DELAY_MS is set
    4.96 seconds ./spec/lib/tasks/dev_rake_spec.rb:327
  dev rake tasks dev:random_in_person_users creates the enrollment in USPS IPPaaS when CREATE_PENDING_ENROLLMENT_IN_USPS is truthy
    4.53 seconds ./spec/lib/tasks/dev_rake_spec.rb:298
  dev rake tasks dev:random_users skips previously verified users
    1.05 seconds ./spec/lib/tasks/dev_rake_spec.rb:61
  dev rake tasks dev:random_in_person_users skips previously added pending enrollments
    1.04 seconds ./spec/lib/tasks/dev_rake_spec.rb:136
  dev rake tasks dev:random_in_person_users defaults to MAX_NUM_ATTEMPTS=3 if not specified
    1.01 seconds ./spec/lib/tasks/dev_rake_spec.rb:396
  dev rake tasks dev:random_in_person_users stops retrying after MAX_NUM_ATTEMPTS attempts and fails the transaction
    0.99827 seconds ./spec/lib/tasks/dev_rake_spec.rb:365
  dev rake tasks dev:random_in_person_users can create passed enrollments
    0.96298 seconds ./spec/lib/tasks/dev_rake_spec.rb:273
  dev rake tasks dev:random_in_person_users can create expired enrollments
    0.95324 seconds ./spec/lib/tasks/dev_rake_spec.rb:223
  dev rake tasks dev:random_users runs successfully
    0.88316 seconds ./spec/lib/tasks/dev_rake_spec.rb:33
  dev rake tasks dev:random_in_person_users can create failed enrollments
    0.87467 seconds ./spec/lib/tasks/dev_rake_spec.rb:248

Top 10 slowest example groups:
  dev rake tasks
    1.23 seconds average (20.93 seconds / 17 examples) ./spec/lib/tasks/dev_rake_spec.rb:4
  DataRequests::LookupSharedDeviceUsers
    0.27623 seconds average (0.27623 seconds / 1 example) ./spec/lib/data_requests/lookup_shared_device_users_spec.rb:3
  DataRequests::CreateUserEventsReport
    0.15054 seconds average (0.15054 seconds / 1 example) ./spec/lib/data_requests/create_user_events_report_spec.rb:3
  DataRequests::CreateUserReport
    0.15053 seconds average (0.45159 seconds / 3 examples) ./spec/lib/data_requests/create_user_report_spec.rb:3
  DataRequests::CreateMfaConfigurationsReport
    0.14623 seconds average (0.73117 seconds / 5 examples) ./spec/lib/data_requests/create_mfa_configurations_report_spec.rb:3
  rotate
    0.09882 seconds average (0.29647 seconds / 3 examples) ./spec/lib/tasks/rotate_rake_spec.rb:4
  partners rake tasks
    0.09493 seconds average (1.52 seconds / 16 examples) ./spec/lib/tasks/partners_rake_spec.rb:4
  DataRequests::CreateEmailAddressesReport
    0.08731 seconds average (0.08731 seconds / 1 example) ./spec/lib/data_requests/create_email_addresses_report_spec.rb:3
  QueryTracker
    0.07739 seconds average (0.15477 seconds / 2 examples) ./spec/lib/query_tracker_spec.rb:4
  MakefileHelpParser
    0.07421 seconds average (0.22264 seconds / 3 examples) ./spec/lib/makefile_help_parser_spec.rb:5

Finished in 41.34 seconds (files took 2.72 seconds to load)
345 examples, 0 failures

Randomized with seed 22313

Coverage report generated for RSpec to /home/jmax/projects/identity-idp/coverage. 4379 / 35253 LOC (12.42%) covered.
